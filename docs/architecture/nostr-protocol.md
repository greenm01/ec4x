# EC4X Nostr Protocol

This document specifies how EC4X uses the Nostr protocol for game
coordination, state synchronization, and player communication.

## Overview

EC4X uses a central relay architecture where the relay server is also
the authoritative game engine. The Nostr protocol serves as the
transport layer for:

- Game discovery and invitations
- Player identity and authentication
- Turn order submission
- Game state synchronization

```
┌─────────────────────────────────────────────────────────────┐
│                      EC4X RELAY                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Nostr Relay │─>│ Game Engine │─>│ Database (SQLite)   │  │
│  │  (NIP-01)   │  │    (Nim)    │  │   Authoritative     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                           ▲
                           │ wss://
           ┌───────────────┼───────────────┐
           │               │               │
       ┌───┴───┐       ┌───┴───┐       ┌───┴───┐
       │ Admin │       │ Admin │       │Player │
       └───────┘       └───────┘       └───────┘
```

The server database is the authoritative source of game state. Nostr
events are used for real-time updates and client-server communication,
not as the primary data store.

---

## Roles & Permissions

### Role Definitions

| Role | Title | Description |
|------|-------|-------------|
| Sysop | Relay Sysop | Runs the server, grants Admin privileges |
| Admin | Game Admin | Creates and manages games |
| Player | Player | Joins games, submits orders |

### Permission Matrix

| Action | Player | Admin | Sysop |
|--------|--------|-------|-------|
| Join game with invite code | Y | Y | Y |
| View/play own games | Y | Y | Y |
| Submit orders | Y | Y | Y |
| Create game | - | Y | Y |
| Reissue invite code | - | Own games | Any game |
| Start game | - | Own games | Any game |
| Delete/cancel game | - | Own games | Any game |
| Grant Admin role | - | - | Y |
| Revoke Admin role | - | - | Y |
| Server maintenance | - | - | Y |

### Notes

- An Admin can also be a Player in their own game
- Each game has a single Admin (the creator)
- Sysop grants Admin privileges via CLI

---

## Binaries

| Binary | Location | Role | Description |
|--------|----------|------|-------------|
| `ec4x-player` | User machine | Player/Admin | TUI client with role-based UI |
| `ec4x-daemon` | Server | - | Nostr relay + game engine + persistence |
| `ec4x` | Server | Sysop | CLI tool for sysop tasks |

The `ec4x-player` binary serves both Players and Admins. The UI adapts
based on the user's npub privileges:

- Players see: game list, invite code input
- Admins see: game list, invite code input, game management menu

---

## Identity

### Storage

Player identity is stored locally at:

```
~/.local/share/ec4x/identity.kdl
```

Format:

```kdl
identity {
  nsec "hex-encoded-private-key"
  npub "hex-encoded-public-key"
  type "local"  // or "imported"
  created "2026-01-17T12:00:00Z"
}
```

### Identity Types

| Type | Description |
|------|-------------|
| `local` | Auto-generated by client on first launch |
| `imported` | User imported their own nsec |

### First Launch Flow

```
┌─────────────────────────────────────────────────────────────┐
│ No identity found.                                          │
│                                                             │
│ A new identity has been created for you.                    │
│ npub1abc...xyz                                              │
│                                                             │
│ To use an existing Nostr identity, press [I] to import.     │
└─────────────────────────────────────────────────────────────┘
```

Players can import an existing nsec if they want to use their Nostr
identity across clients or other Nostr applications.

---

## Invite Codes

Games are invitation-only. Players join by entering an invite code
provided by the Game Admin.

### Format

Invite codes consist of two words from the Monero mnemonic wordlist,
hyphenated and lowercase:

```
velvet-mountain
copper-sunrise
silent-harbor
crystal-thunder
```

The wordlist contains 1626 words, giving ~2.6 million combinations.
This is sufficient entropy for private invite codes that are not
brute-forced.

### Invite Code Lifecycle

```
┌──────────────┐    player claims    ┌──────────────┐
│   PENDING    │ ──────────────────► │   CLAIMED    │
│  (no npub)   │    with npub        │ (bound npub) │
└──────────────┘                     └──────────────┘
       │                                    │
       │ admin                              │ admin
       │ deletes slot                       │ reissues
       ▼                                    ▼
┌──────────────┐                     ┌──────────────┐
│   DELETED    │                     │   PENDING    │
│              │                     │ (new code)   │
└──────────────┘                     └──────────────┘
```

### Security Model

- Invite codes are **bearer tokens**: whoever presents one first claims
  the slot
- Codes should be shared **privately** (DM, email) not publicly
- Once claimed, the code is bound to that npub permanently
- If a player loses their identity, the Admin reissues a new code

### Reissue Flow

When an Admin reissues a code:

1. The old code becomes invalid
2. A new code is generated for that slot
3. The slot's npub binding is cleared
4. The player can claim with their new npub

```bash
# Sysop CLI (or Admin via TUI)
$ ec4x game reissue friday-night --slot 2
Slot 2 reset. New invite code: amber-cascade
```

---

## Game Lifecycle

### States

```
SETUP ──────────► ACTIVE ──────────► FINISHED
        Admin            Game ends
        starts           (victory or
        game             concession)
```

| State | Description |
|-------|-------------|
| `SETUP` | Game created, waiting for players to claim slots |
| `ACTIVE` | Game in progress, turns being resolved |
| `FINISHED` | Game complete, winner determined |

### Creation Flow

1. Admin creates game (via TUI)
2. Server generates invite codes for each slot
3. Admin shares codes privately with players
4. Players claim slots by entering codes
5. Admin starts game when ready

### House Assignment

Houses are assigned randomly when a player claims their slot. There
are 12 possible house names (fixed list, no custom names to prevent
abuse).

---

## Nostr Event Kinds

EC4X uses the 304xx range for parameterized replaceable events.

| Kind | Name | Publisher | Description |
|------|------|-----------|-------------|
| 30400 | Game Definition | Admin | Game metadata, slot status |
| 30401 | Player Slot Claim | Player | Player claims invite code |
| 30402 | Turn Orders | Player | Player's orders for a turn |
| 30403 | Turn Results | Server | Delta from turn resolution |
| 30405 | Game State | Server | Full current state |

### 30400: Game Definition

Published by Admin when creating or updating a game.

```json
{
  "kind": 30400,
  "pubkey": "<admin-npub>",
  "created_at": 1705500000,
  "tags": [
    ["d", "<game-id>"],
    ["name", "Friday Night Game"],
    ["status", "setup"],
    ["slot", "1", "<invite-code-hash>", "", "pending"],
    ["slot", "2", "<invite-code-hash>", "", "pending"],
    ["slot", "3", "<invite-code-hash>", "<player-npub>", "claimed"],
    ["slot", "4", "<invite-code-hash>", "", "pending"]
  ],
  "content": "{\"config\": {...}}",
  "sig": "..."
}
```

**Tag definitions:**

- `d`: Unique game identifier
- `name`: Human-readable game name
- `status`: `setup`, `active`, or `finished`
- `slot`: `[index, invite-code-hash, npub-or-empty, status]`

Invite codes are stored as hashes to prevent leaking codes in public
events. The server validates the actual code on claim.

### 30401: Player Slot Claim

Published by Player when claiming an invite code.

```json
{
  "kind": 30401,
  "pubkey": "<player-npub>",
  "created_at": 1705500100,
  "tags": [
    ["d", "<game-id>"],
    ["code", "<invite-code>"]
  ],
  "content": "",
  "sig": "..."
}
```

The server validates:

1. Code exists and is pending
2. Code not already claimed
3. Binds player npub to slot
4. Assigns random house
5. Updates game definition (30400)

### 30402: Turn Commands

Published by Player when submitting commands for a turn.

```json
{
  "kind": 30402,
  "pubkey": "<player-npub>",
  "created_at": 1705500200,
  "tags": [
    ["d", "<game-id>"],
    ["turn", "5"],
    ["p", "<daemon-npub>"]
  ],
  "content": "<encrypted-compressed-kdl>",
  "sig": "..."
}
```

The content field contains: `base64(NIP-44-encrypt(zippy-compress(kdl)))`

See [KDL Payload Formats](#kdl-payload-formats) for the KDL structure.

### 30403: Turn Results

Published by Server after resolving a turn. One event per player,
encrypted to that player's pubkey.

```json
{
  "kind": 30403,
  "pubkey": "<daemon-npub>",
  "created_at": 1705500300,
  "tags": [
    ["d", "<game-id>"],
    ["turn", "5"],
    ["p", "<player-npub>"]
  ],
  "content": "<encrypted-compressed-kdl>",
  "sig": "..."
}
```

The content field contains: `base64(NIP-44-encrypt(zippy-compress(kdl)))`

The delta contains only the changes from this turn, filtered by fog of
war for the target player. Clients apply deltas to their local state.

See [KDL Payload Formats](#kdl-payload-formats) for the KDL structure.

### 30405: Game State

Published by Server, contains full current game state for a player.
Encrypted to that player's pubkey with fog-of-war filtering.

```json
{
  "kind": 30405,
  "pubkey": "<daemon-npub>",
  "created_at": 1705500300,
  "tags": [
    ["d", "<game-id>"],
    ["turn", "5"],
    ["p", "<player-npub>"]
  ],
  "content": "<encrypted-compressed-kdl>",
  "sig": "..."
}
```

The content field contains: `base64(NIP-44-encrypt(zippy-compress(kdl)))`

Clients request this when:

- First connecting to a game
- Local state is corrupted or missing
- Manual resync requested

See [KDL Payload Formats](#kdl-payload-formats) for the KDL structure.

---

## Wire Format

All encrypted payloads use this format:

```
KDL string -> zippy compress -> NIP-44 encrypt -> base64 encode
```

**Encoding (sender):**
1. Generate KDL string from game data
2. Compress with zippy (gzip)
3. Encrypt with NIP-44 to recipient's pubkey
4. Base64 encode for Nostr content field

**Decoding (receiver):**
1. Base64 decode content field
2. Decrypt with NIP-44 using own private key
3. Decompress with zippy
4. Parse KDL string

---

## Message Flows

### Player Joins Game

```
Player                              Server
   │                                   │
   │  EVENT 30401 (claim code)         │
   ├──────────────────────────────────►│
   │                                   │ Validate code
   │                                   │ Bind npub to slot
   │                                   │ Assign house
   │                                   │
   │  EVENT 30400 (updated game def)   │
   │◄──────────────────────────────────┤
   │                                   │
   │  REQ {"kinds":[30405],            │
   │       "#d":["<game-id>"]}         │
   ├──────────────────────────────────►│
   │                                   │
   │  EVENT 30405 (full state)         │
   │◄──────────────────────────────────┤
```

### Player Submits Orders

```
Player                              Server
   │                                   │
   │  EVENT 30402 (turn orders)        │
   ├──────────────────────────────────►│
   │                                   │ Validate orders
   │                                   │ Store in DB
   │  OK                               │
   │◄──────────────────────────────────┤
```

### Turn Resolution

```
Server                              All Players
   │                                   │
   │ (all orders received or timeout)  │
   │                                   │
   │ Run game engine                   │
   │ Calculate deltas                  │
   │                                   │
   │  EVENT 30403 (turn results)       │
   ├──────────────────────────────────►│
   │                                   │ Apply delta
   │                                   │ Update UI
```

### State Recovery

```
Player                              Server
   │                                   │
   │  REQ {"kinds":[30405],            │
   │       "#d":["<game-id>"]}         │
   ├──────────────────────────────────►│
   │                                   │
   │  EVENT 30405 (full state)         │
   │◄──────────────────────────────────┤
   │                                   │
   │  REQ {"kinds":[30403],            │
   │       "#d":["<game-id>"],         │
   │       "since":<last-event-time>}  │
   ├──────────────────────────────────►│
   │                                   │
   │  (subscribe to future deltas)     │
   │◄─────────────────────────────────►│
```

---

## Client Entry Screen

When a player opens the TUI client:

```
┌─────────────────────────────────────────────────────────────┐
│                         E C 4 X                             │
│                                                             │
│  IDENTITY ────────────────────────────────────────────────  │
│  npub1abc...xyz (local)                    [I] Import nsec  │
│                                                             │
│  YOUR GAMES ──────────────────────────────────────────────  │
│  ► Friday Night          T5    House Valdez                 │
│    Saturday Showdown     T1    House Kirin                  │
│                                                             │
│  JOIN GAME ───────────────────────────────────────────────  │
│  Enter invite code: [____________]                          │
│                                                             │
│  [Up/Dn] Select  [Enter] Play  [I] Import  [Q] Quit         │
└─────────────────────────────────────────────────────────────┘
```

If the player has Admin privileges, they also see:

```
│  ADMIN ───────────────────────────────────────────────────  │
│  ► Create New Game                                          │
│    Manage My Games (2)                                      │
```

---

## Security Considerations

### Invite Codes

- Codes are bearer tokens; treat them like passwords
- Share privately (DM, email), never in public channels
- Codes are hashed in public events to prevent leakage
- Rate-limit code claim attempts to prevent brute-force

### Identity

- Private keys (nsec) never leave the client
- All events are signed with the player's key
- Server verifies signatures on all events

### Server Authority

- The server is the authoritative source of game state
- Clients should validate server-signed events
- The server npub should be well-known and verifiable

### Fog of War

- Turn results (30403) contain only information visible to each player
- Or: separate events per player with encrypted content
- Full state (30405) is player-specific (filtered by visibility)

---

## Future Considerations

### Multiple Relays

The current design assumes a single central relay. Future versions
could support:

- Relay redundancy (multiple relays, same data)
- Federated games (different games on different relays)
- Relay discovery via NIP-65

### Encrypted Events

For games requiring hidden information:

- Use NIP-04 or NIP-44 for encrypted DMs
- Per-player encrypted turn results
- Encrypted order submission

### Spectator Mode

- Read-only access to game state
- Could use a separate "spectator" invite code type
- Delayed state (fog of war for spectators)

---

## KDL Payload Formats

All encrypted event payloads use KDL format. This section defines the
KDL schemas for commands, deltas, and full state.

### Command Packet (30402)

Player commands submitted each turn. Parsed by `kdl_orders.nim`.

```kdl
commands house=(HouseId)1 turn=5 {
  // Fleet commands - movement, combat, colonization
  fleet (FleetId)123 {
    move to=(SystemId)456 priority=1 roe=3
  }
  fleet (FleetId)789 hold
  fleet (FleetId)101 {
    colonize at=(SystemId)200
  }
  fleet (FleetId)102 {
    patrol from=(SystemId)10 to=(SystemId)20
  }
  fleet (FleetId)103 {
    join-fleet target=(FleetId)123
  }

  // Build commands - ships, facilities, ground units
  build (ColonyId)1 {
    ship Destroyer quantity=2
    ship Cruiser quantity=1
    facility Shipyard
    ground Marine quantity=5
    industrial units=10
  }

  // Scrap commands - salvage entities for PP
  scrap (ColonyId)1 {
    ship (ShipId)99 acknowledge-queue-loss=false
    ground-unit (GroundUnitId)50
  }

  // Research allocation
  research {
    economic 100
    science 50
    tech {
      weapons 40
      shields 20
      construction 10
    }
  }

  // Diplomacy
  diplomacy {
    declare-hostile target=(HouseId)3
    propose-alliance target=(HouseId)2
    accept-proposal id=(ProposalId)5
  }

  // Espionage
  espionage {
    invest ebp=200 cip=80
    tech-theft target=(HouseId)2
    sabotage-high target=(HouseId)3 system=(SystemId)50
  }

  // Population transfers
  transfer from=(ColonyId)1 to=(ColonyId)2 ptu=50

  // Terraforming
  terraform colony=(ColonyId)3

  // Colony management
  colony (ColonyId)1 {
    tax-rate 60
    auto-repair true
    auto-load-fighters true
    auto-load-marines false
  }
}
```

### Turn Delta (30403)

State changes from turn resolution, filtered by fog of war.

```kdl
delta turn=5 game="550e8400-e29b-41d4-a716-446655440000" {
  // Fleet movements visible to this house
  fleet-moved id=(FleetId)123 from=(SystemId)100 to=(SystemId)101
  fleet-moved id=(FleetId)456 from=(SystemId)200 to=(SystemId)201

  // Fleet destroyed
  fleet-destroyed id=(FleetId)789 at=(SystemId)101 by=(HouseId)2

  // Combat results
  combat at=(SystemId)101 {
    attacker house=(HouseId)1 fleet=(FleetId)123
    defender house=(HouseId)2 fleet=(FleetId)789
    result "attacker-victory"
    losses attacker=2 defender=5
  }

  // Colony updates (own colonies get full detail)
  colony-updated id=(ColonyId)1 {
    population 850
    industry 430
    treasury-contribution 215
  }

  // Colony captured
  colony-captured id=(ColonyId)99 {
    system=(SystemId)50
    old-owner=(HouseId)3
    new-owner=(HouseId)1
  }

  // Tech advancement
  tech-advance house=(HouseId)1 field="weapons" level=3 breakthrough="minor"

  // Diplomatic changes
  relation-changed from=(HouseId)1 to=(HouseId)3 {
    old-status "hostile"
    new-status "war"
    reason "Declaration of war"
  }

  // Ship commissioned
  ship-commissioned colony=(ColonyId)1 {
    ship-class "Destroyer"
    fleet=(FleetId)500
  }

  // Intel gathered (what we learned about enemies)
  intel {
    fleet-detected id=(FleetId)999 owner=(HouseId)2 {
      location=(SystemId)30
      estimated-ships=5
    }
    colony-intel id=(ColonyId)88 owner=(HouseId)3 {
      system=(SystemId)40
      estimated-population=600
      estimated-industry=300
    }
  }

  // Events visible to this house
  events {
    event type="ShipCommissioned" {
      description "Destroyer commissioned at Alpha Prime"
      colony=(ColonyId)1
      ship-class "Destroyer"
    }
    event type="BattleOccurred" {
      description "Battle at Tau Ceti - House Alpha victorious"
      system=(SystemId)101
      outcome "attacker-victory"
    }
    event type="TechAdvance" {
      description "Weapons technology advanced to level 3"
      tech-field "weapons"
      new-level 3
    }
    event type="SpyMissionSucceeded" {
      description "Intelligence gathered on House Beta colony"
      target=(HouseId)2
    }
  }
}
```

### Full State (30405)

Complete game state for initial sync or resync.

```kdl
state turn=5 game="550e8400-e29b-41d4-a716-446655440000" {
  viewing-house id=(HouseId)1 name="House Alpha"

  // Own house info (full detail)
  house {
    treasury 5000
    prestige 250
    eliminated false
    tech {
      economic 2
      science 1
      weapons 3
      shields 2
      construction 2
      terraforming 1
      electronic-intelligence 1
      cloaking 1
      strategic-lift 1
      counter-intelligence 1
      flagship-command 1
      strategic-command 1
      fighter-doctrine 1
      advanced-carrier-operations 1
    }
  }

  // Owned colonies (full detail)
  colonies {
    colony id=(ColonyId)1 system=(SystemId)10 name="Alpha Prime" {
      population 840
      industry 420
      tax-rate 50
      auto-repair true
      under-siege false
      facilities {
        spaceport 1
        shipyard 2
        drydock 1
        starbase 1
      }
      ground-units {
        army 10
        marine 5
        ground-battery 3
        planetary-shield 1
      }
      construction-queue {
        project type="ship" class="Cruiser" progress=50 cost=100
        project type="facility" class="Shipyard" progress=0 cost=200
      }
    }
    colony id=(ColonyId)2 system=(SystemId)15 name="New Terra" {
      population 200
      industry 100
      tax-rate 50
    }
  }

  // Owned fleets (full detail)
  fleets {
    fleet id=(FleetId)1 location=(SystemId)10 name="Alpha Fleet" {
      command type="guard-colony"
      ship id=(ShipId)100 class="Destroyer" hp=10 max-hp=10 tech-level=2
      ship id=(ShipId)101 class="Cruiser" hp=15 max-hp=15 tech-level=2
      ship id=(ShipId)102 class="ETAC" hp=5 max-hp=5 {
        cargo ptu=3
      }
    }
    fleet id=(FleetId)2 location=(SystemId)20 name="Scout Wing" {
      command type="scout-system" target=(SystemId)25
      ship id=(ShipId)200 class="Destroyer" hp=10 max-hp=10
    }
  }

  // Visible systems (fog of war filtered)
  systems {
    system id=(SystemId)10 name="Alpha Centauri" {
      visibility "owned"
      coords q=0 r=0
      ring 0
      planet-class "Eden"
      resource-rating "Abundant"
      lanes (SystemId)11 (SystemId)12 (SystemId)15
    }
    system id=(SystemId)11 name="Tau Ceti" {
      visibility "scouted"
      last-scouted 4
      coords q=1 r=0
      ring 1
      lanes (SystemId)10 (SystemId)20
    }
    system id=(SystemId)20 name="Unknown System" {
      visibility "adjacent"
      coords q=2 r=0
      ring 2
    }
  }

  // Enemy intel (fog of war - what we've observed)
  intel {
    fleets {
      fleet id=(FleetId)999 owner=(HouseId)2 {
        location=(SystemId)30
        detected-turn 4
        estimated-ships 5
        quality "visual"
      }
    }
    colonies {
      colony id=(ColonyId)99 owner=(HouseId)3 {
        system=(SystemId)40
        intel-turn 3
        estimated-population 500
        estimated-industry 250
        quality "scan"
      }
    }
    systems {
      system id=(SystemId)30 {
        last-scouted 4
        owner=(HouseId)2
      }
    }
  }

  // Public information (all players see this)
  standings {
    house id=(HouseId)1 name="House Alpha" prestige=250 colonies=2
    house id=(HouseId)2 name="House Beta" prestige=180 colonies=2
    house id=(HouseId)3 name="House Gamma" prestige=200 colonies=3
    house id=(HouseId)4 name="House Delta" prestige=150 colonies=2 eliminated=true
  }

  diplomacy {
    relation (HouseId)1 (HouseId)2 status="peace" since-turn=1
    relation (HouseId)1 (HouseId)3 status="war" since-turn=3
    relation (HouseId)2 (HouseId)3 status="hostile" since-turn=2
  }

  // Pending diplomatic proposals
  proposals {
    proposal id=(ProposalId)1 {
      from=(HouseId)2
      to=(HouseId)1
      type "alliance"
      expires-turn 6
    }
  }
}
```

### KDL Type Annotations

EC4X uses KDL type annotations for entity IDs:

| Type | Example | Description |
|------|---------|-------------|
| `(HouseId)` | `(HouseId)1` | House/faction identifier |
| `(FleetId)` | `(FleetId)123` | Fleet identifier |
| `(ShipId)` | `(ShipId)456` | Ship identifier |
| `(ColonyId)` | `(ColonyId)789` | Colony identifier |
| `(SystemId)` | `(SystemId)10` | Star system identifier |
| `(ProposalId)` | `(ProposalId)5` | Diplomatic proposal ID |

These are parsed by `nimkdl` and converted to the appropriate Nim types.
