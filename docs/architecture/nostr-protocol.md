# EC4X Nostr Protocol

This document specifies how EC4X uses the Nostr protocol for game
coordination, state synchronization, and player communication.

## Overview

EC4X uses a central relay architecture where the relay server is also
the authoritative game engine. The Nostr protocol serves as the
transport layer for:

- Game discovery and invitations
- Player identity and authentication
- Turn order submission
- Game state synchronization

```
┌─────────────────────────────────────────────────────────────┐
│                      EC4X RELAY                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Nostr Relay │─>│ Game Engine │─>│ Database (SQLite)   │  │
│  │  (NIP-01)   │  │    (Nim)    │  │   Authoritative     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                           ▲
                           │ wss://
           ┌───────────────┼───────────────┐
           │               │               │
       ┌───┴───┐       ┌───┴───┐       ┌───┴───┐
       │ Admin │       │ Admin │       │Player │
       └───────┘       └───────┘       └───────┘
```

The server database is the authoritative source of game state. Nostr
events are used for real-time updates and client-server communication,
not as the primary data store.

---

## Roles & Permissions

### Role Definitions

| Role | Title | Description |
|------|-------|-------------|
| Sysop | Relay Sysop | Runs the server, grants Admin privileges |
| Admin | Game Admin | Creates and manages games |
| Player | Player | Joins games, submits orders |

### Permission Matrix

| Action | Player | Admin | Sysop |
|--------|--------|-------|-------|
| Join game with invite code | Y | Y | Y |
| View/play own games | Y | Y | Y |
| Submit orders | Y | Y | Y |
| Create game | - | Y | Y |
| Reissue invite code | - | Own games | Any game |
| Start game | - | Own games | Any game |
| Delete/cancel game | - | Own games | Any game |
| Grant Admin role | - | - | Y |
| Revoke Admin role | - | - | Y |
| Server maintenance | - | - | Y |

### Notes

- An Admin can also be a Player in their own game
- Each game has a single Admin (the creator)
- Sysop grants Admin privileges via CLI

---

## Binaries

| Binary | Location | Role | Description |
|--------|----------|------|-------------|
| `ec4x-player` | User machine | Player/Admin | TUI client with role-based UI |
| `ec4x-daemon` | Server | - | Nostr relay + game engine + persistence |
| `ec4x` | Server | Sysop | CLI tool for sysop tasks |

The `ec4x-player` binary serves both Players and Admins. The UI adapts
based on the user's npub privileges:

- Players see: game list, invite code input
- Admins see: game list, invite code input, game management menu

---

## Identity

### Storage

Player identity is stored locally at:

```
~/.local/share/ec4x/identity.kdl
```

Format:

```kdl
identity {
  nsec "hex-encoded-private-key"
  npub "hex-encoded-public-key"
  type "local"  // or "imported"
  created "2026-01-17T12:00:00Z"
}
```

### Identity Types

| Type | Description |
|------|-------------|
| `local` | Auto-generated by client on first launch |
| `imported` | User imported their own nsec |

### First Launch Flow

```
┌─────────────────────────────────────────────────────────────┐
│ No identity found.                                          │
│                                                             │
│ A new identity has been created for you.                    │
│ npub1abc...xyz                                              │
│                                                             │
│ To use an existing Nostr identity, press [I] to import.     │
└─────────────────────────────────────────────────────────────┘
```

Players can import an existing nsec if they want to use their Nostr
identity across clients or other Nostr applications.

---

## Invite Codes

Games are invitation-only. Players join by entering an invite code
provided by the Game Admin.

### Format

Invite codes consist of two words from the Monero mnemonic wordlist,
hyphenated and lowercase:

```
velvet-mountain
copper-sunrise
silent-harbor
crystal-thunder
```

The wordlist contains 1626 words, giving ~2.6 million combinations.
This is sufficient entropy for private invite codes that are not
brute-forced.

### Invite Code Lifecycle

```
┌──────────────┐    player claims    ┌──────────────┐
│   PENDING    │ ──────────────────► │   CLAIMED    │
│  (no npub)   │    with npub        │ (bound npub) │
└──────────────┘                     └──────────────┘
       │                                    │
       │ admin                              │ admin
       │ deletes slot                       │ reissues
       ▼                                    ▼
┌──────────────┐                     ┌──────────────┐
│   DELETED    │                     │   PENDING    │
│              │                     │ (new code)   │
└──────────────┘                     └──────────────┘
```

### Security Model

- Invite codes are **bearer tokens**: whoever presents one first claims
  the slot
- Codes should be shared **privately** (DM, email) not publicly
- Once claimed, the code is bound to that npub permanently
- If a player loses their identity, the Admin reissues a new code

### Reissue Flow

When an Admin reissues a code:

1. The old code becomes invalid
2. A new code is generated for that slot
3. The slot's npub binding is cleared
4. The player can claim with their new npub

```bash
# Sysop CLI (or Admin via TUI)
$ ec4x game reissue friday-night --slot 2
Slot 2 reset. New invite code: amber-cascade
```

---

## Game Lifecycle

### States

```
SETUP ──────────► ACTIVE ──────────► FINISHED
        Admin            Game ends
        starts           (victory or
        game             concession)
```

| State | Description |
|-------|-------------|
| `SETUP` | Game created, waiting for players to claim slots |
| `ACTIVE` | Game in progress, turns being resolved |
| `FINISHED` | Game complete, winner determined |

### Creation Flow

1. Admin creates game (via TUI)
2. Server generates invite codes for each slot
3. Admin shares codes privately with players
4. Players claim slots by entering codes
5. Admin starts game when ready

### House Assignment

Houses are assigned randomly when a player claims their slot. There
are 12 possible house names (fixed list, no custom names to prevent
abuse).

---

## Nostr Event Kinds

EC4X uses the 304xx range for parameterized replaceable events.

| Kind | Name | Publisher | Description |
|------|------|-----------|-------------|
| 30400 | Game Definition | Admin | Game metadata, slot status |
| 30401 | Player Slot Claim | Player | Player claims invite code |
| 30402 | Turn Orders | Player | Player's orders for a turn |
| 30403 | Turn Results | Server | Delta from turn resolution |
| 30405 | Game State | Server | Full current state |

### 30400: Game Definition

Published by Admin when creating or updating a game.

```json
{
  "kind": 30400,
  "pubkey": "<admin-npub>",
  "created_at": 1705500000,
  "tags": [
    ["d", "<game-id>"],
    ["name", "Friday Night Game"],
    ["status", "setup"],
    ["slot", "1", "<invite-code-hash>", "", "pending"],
    ["slot", "2", "<invite-code-hash>", "", "pending"],
    ["slot", "3", "<invite-code-hash>", "<player-npub>", "claimed"],
    ["slot", "4", "<invite-code-hash>", "", "pending"]
  ],
  "content": "{\"config\": {...}}",
  "sig": "..."
}
```

**Tag definitions:**

- `d`: Unique game identifier
- `name`: Human-readable game name
- `status`: `setup`, `active`, or `finished`
- `slot`: `[index, invite-code-hash, npub-or-empty, status]`

Invite codes are stored as hashes to prevent leaking codes in public
events. The server validates the actual code on claim.

### 30401: Player Slot Claim

Published by Player when claiming an invite code.

```json
{
  "kind": 30401,
  "pubkey": "<player-npub>",
  "created_at": 1705500100,
  "tags": [
    ["d", "<game-id>"],
    ["code", "<invite-code>"]
  ],
  "content": "",
  "sig": "..."
}
```

The server validates:

1. Code exists and is pending
2. Code not already claimed
3. Binds player npub to slot
4. Assigns random house
5. Updates game definition (30400)

### 30402: Turn Orders

Published by Player when submitting orders for a turn.

```json
{
  "kind": 30402,
  "pubkey": "<player-npub>",
  "created_at": 1705500200,
  "tags": [
    ["d", "<game-id>"],
    ["turn", "5"]
  ],
  "content": "<orders-payload>",
  "sig": "..."
}
```

The orders payload format is defined in the game engine specification.

### 30403: Turn Results

Published by Server after resolving a turn.

```json
{
  "kind": 30403,
  "pubkey": "<server-npub>",
  "created_at": 1705500300,
  "tags": [
    ["d", "<game-id>"],
    ["turn", "5"]
  ],
  "content": "<delta-payload>",
  "sig": "..."
}
```

The delta contains only the changes from this turn, not full state.
Clients apply deltas to their local state cache.

### 30405: Game State

Published by Server, contains full current game state.

```json
{
  "kind": 30405,
  "pubkey": "<server-npub>",
  "created_at": 1705500300,
  "tags": [
    ["d", "<game-id>"],
    ["turn", "5"]
  ],
  "content": "<full-state-payload>",
  "sig": "..."
}
```

Clients request this when:

- First connecting to a game
- Local state is corrupted or missing
- Manual resync requested

---

## Message Flows

### Player Joins Game

```
Player                              Server
   │                                   │
   │  EVENT 30401 (claim code)         │
   ├──────────────────────────────────►│
   │                                   │ Validate code
   │                                   │ Bind npub to slot
   │                                   │ Assign house
   │                                   │
   │  EVENT 30400 (updated game def)   │
   │◄──────────────────────────────────┤
   │                                   │
   │  REQ {"kinds":[30405],            │
   │       "#d":["<game-id>"]}         │
   ├──────────────────────────────────►│
   │                                   │
   │  EVENT 30405 (full state)         │
   │◄──────────────────────────────────┤
```

### Player Submits Orders

```
Player                              Server
   │                                   │
   │  EVENT 30402 (turn orders)        │
   ├──────────────────────────────────►│
   │                                   │ Validate orders
   │                                   │ Store in DB
   │  OK                               │
   │◄──────────────────────────────────┤
```

### Turn Resolution

```
Server                              All Players
   │                                   │
   │ (all orders received or timeout)  │
   │                                   │
   │ Run game engine                   │
   │ Calculate deltas                  │
   │                                   │
   │  EVENT 30403 (turn results)       │
   ├──────────────────────────────────►│
   │                                   │ Apply delta
   │                                   │ Update UI
```

### State Recovery

```
Player                              Server
   │                                   │
   │  REQ {"kinds":[30405],            │
   │       "#d":["<game-id>"]}         │
   ├──────────────────────────────────►│
   │                                   │
   │  EVENT 30405 (full state)         │
   │◄──────────────────────────────────┤
   │                                   │
   │  REQ {"kinds":[30403],            │
   │       "#d":["<game-id>"],         │
   │       "since":<last-event-time>}  │
   ├──────────────────────────────────►│
   │                                   │
   │  (subscribe to future deltas)     │
   │◄─────────────────────────────────►│
```

---

## Client Entry Screen

When a player opens the TUI client:

```
┌─────────────────────────────────────────────────────────────┐
│                         E C 4 X                             │
│                                                             │
│  IDENTITY ────────────────────────────────────────────────  │
│  npub1abc...xyz (local)                    [I] Import nsec  │
│                                                             │
│  YOUR GAMES ──────────────────────────────────────────────  │
│  ► Friday Night          T5    House Valdez                 │
│    Saturday Showdown     T1    House Kirin                  │
│                                                             │
│  JOIN GAME ───────────────────────────────────────────────  │
│  Enter invite code: [____________]                          │
│                                                             │
│  [Up/Dn] Select  [Enter] Play  [I] Import  [Q] Quit         │
└─────────────────────────────────────────────────────────────┘
```

If the player has Admin privileges, they also see:

```
│  ADMIN ───────────────────────────────────────────────────  │
│  ► Create New Game                                          │
│    Manage My Games (2)                                      │
```

---

## Security Considerations

### Invite Codes

- Codes are bearer tokens; treat them like passwords
- Share privately (DM, email), never in public channels
- Codes are hashed in public events to prevent leakage
- Rate-limit code claim attempts to prevent brute-force

### Identity

- Private keys (nsec) never leave the client
- All events are signed with the player's key
- Server verifies signatures on all events

### Server Authority

- The server is the authoritative source of game state
- Clients should validate server-signed events
- The server npub should be well-known and verifiable

### Fog of War

- Turn results (30403) contain only information visible to each player
- Or: separate events per player with encrypted content
- Full state (30405) is player-specific (filtered by visibility)

---

## Future Considerations

### Multiple Relays

The current design assumes a single central relay. Future versions
could support:

- Relay redundancy (multiple relays, same data)
- Federated games (different games on different relays)
- Relay discovery via NIP-65

### Encrypted Events

For games requiring hidden information:

- Use NIP-04 or NIP-44 for encrypted DMs
- Per-player encrypted turn results
- Encrypted order submission

### Spectator Mode

- Read-only access to game state
- Could use a separate "spectator" invite code type
- Delayed state (fog of war for spectators)
