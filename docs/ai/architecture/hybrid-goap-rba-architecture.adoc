= Hybrid GOAP/RBA AI Architecture
:doctype: book
:toc: left
:toclevels: 3
:sectnums:
:icons: font
:last-update-label!:

[.metadata]
****
*Last Updated:* 2025-12-10 +
*Status:* COMPLETE (All identified Gaps 1-7 addressed) +
*System:* Byzantine Imperial AI with Strategic Planning Layer
****

== Executive Summary

The *Hybrid GOAP/RBA Architecture* combines two complementary AI systems:

=== GOAP (Goal-Oriented Action Planning) - Strategic Layer

* Multi-turn goal planning (3-10 turn horizon)
* Resource allocation strategies
* Goal prioritization and replanning
* High-level coordination

=== RBA (Rule-Based Advisors) - Tactical Layer

* Turn-by-turn order generation
* Budget-constrained fulfillment
* Domain-specific expertise (6 advisors)
* Iterative feedback loops

[IMPORTANT]
====
*Key Principle:* GOAP thinks strategically, RBA acts tactically.
====

=== System Overview

.Hybrid AI System Architecture
****
*GOAP Strategic Layer* (Multi-Turn Planning)

* "Conquer System 42 in 5 turns"
* "Research CST VI by Turn 8"
* "Build invasion fleet (3 turns)"

_Provides:_ Goals, Plans, Cost Estimates

↓

*RBA Tactical Layer* (Turn-by-Turn Execution)

* "Build 2 Battleships this turn"
* "Allocate 300 PP to research"
* "Move Fleet 5 to System 42"
****

== Architecture Overview

=== Two-Layer Decision Hierarchy

.Strategic Horizon (3-10 turns)
[sidebar]
--
*GOAP LAYER*

GOALS → PLANNER (A* Search) → PLANS (Multi-turn)

Input::
* World State
* Opportunities
* Threats

Output::
* Action Sequences
* Cost Estimates
* Dependencies

↓ _Strategic Guidance: Active goals, Plan progress, Cost budgets_
--

.Tactical Horizon (1 turn)
[sidebar]
--
*RBA LAYER*

....
         BASILEUS
    (Turn Coordinator)
             |
    +--------+--------+
    |        |        |
 DRUNG.  TREASURER  DOMESTIKOS
 (Intel)    (CFO)   (Military)
             |
    +--------+--------+
    |        |        |
  LOGO.   EPARCH   PROTO.
  (R&D)  (Economy) (Diplo.)
....
--

=== Responsibility Split

[cols="1,2,1,2"]
|===
|Layer |Responsibility |Time Horizon |Decision Type

|*GOAP*
|What to achieve
|3-10 turns
|Strategic goals

|*GOAP*
|How to sequence
|Multi-turn
|Action planning

|*GOAP*
|When to replan
|Continuous
|Adaptive strategy

|*RBA*
|How to execute
|1 turn
|Tactical orders

|*RBA*
|What to build
|1 turn
|Resource allocation

|*RBA*
|Where to move
|1 turn
|Fleet operations
|===

== Strategic vs Tactical Decision Making

=== GOAP: Strategic Planning (Multi-Turn)

*Purpose:* Answer "What should we achieve in the next 5 turns?"

==== Step 1: Goal Extraction

.Analyze world state and extract strategic goals
****
*Input:* GameState, Intelligence, Advisor Requirements +
*Output:* Prioritized goal list

*Example Goals:*

* Priority 90: "Defend Homeworld (critical)"
* Priority 70: "Conquer System 42"
* Priority 50: "Research CST VI"
* Priority 30: "Expand to 5 colonies"
****

==== Step 2: Plan Generation (A* Search)

.For each goal, generate action sequence
****
*Goal:* "Conquer System 42"

[cols="1,4,1"]
|===
|Turn |Action |Cost

|1
|Build 5 Destroyers
|200 PP

|2
|Build 2 Carriers
|240 PP

|3
|Build 10 Marines
|500 PP

|4
|Move to System 42
|0 PP

|5
|Invade System 42
|0 PP
|===

*Total Cost:* 940 PP over 5 turns +
*Success Probability:* 0.85
****

==== Step 3: Cost Estimation & Prioritization

.Evaluate feasibility and rank goals
****
*Ranking Criteria:*

* Strategic value (survival > expansion)
* Cost efficiency (PP per prestige point)
* Success probability (threat assessment)
* Time to completion (urgent > deferred)

*Final Plan:*

* [x] Goal 1: Defend Homeworld (500 PP, 3 turns)
* [x] Goal 2: Conquer System 42 (940 PP, 5 turns)
* [ ] Goal 3: CST VI (deferred, insufficient PP)
****

==== Step 4: Tactical Handoff to RBA

.Provide current-turn guidance to RBA advisors
****
*Turn 1 Instructions:*

* Domestikos: Build 5 Destroyers (Goal 1)
* Domestikos: Build 2 Frigates (Goal 2)
* Treasurer: Reserve 700 PP for Turn 2-3
* Logothete: Defer CST VI research
****

=== RBA: Tactical Execution (Single-Turn)

*Purpose:* Answer "What should we do THIS turn?"

==== Phase 0: Intelligence Distribution

.Drungarius collects fog-of-war intelligence
****
*Threats:* Enemy fleet at System 15 (20 ships) +
*Opportunities:* System 42 undefended +
*Construction:* Enemy building Battleships
****

==== Phase 1: Requirement Generation

.Each advisor generates THIS TURN requirements
****
*Domestikos:*

* Build 5 Destroyers (Critical, 200 PP)
* Build 2 Frigates (High, 80 PP)
* Build 1 Starbase (Medium, 40 PP)

*Logothete:*

* Research CST (Medium, 150 PP)
* Research ACO (Low, 100 PP)

*Summary:*

Total Requested:: 570 PP
Treasury Available:: 450 PP
Status:: OVER BUDGET → needs Phase 2 mediation
****

==== Phase 1.5: GOAP Guidance (Optional)

.GOAP informs budget allocation priorities
****
*Active Goals:*

Goal 1 (Priority 90):: "Defend Homeworld"
* → Boost Domestikos defense requirements

Goal 2 (Priority 70):: "Conquer System 42"
* → Reserve 240 PP for Turn 2 carriers

*Budget Guidance:*

Strategic:: 360 PP (80%)
Filler:: 90 PP (20%)
Reserved:: 240 PP (next turn)
****

==== Phase 2: Mediation & Allocation

.Treasurer allocates PP budget across advisors
****
*Allocation (GOAP-informed):*

[cols="1,1,2"]
|===
|Advisor |Budget |Reason

|Domestikos
|280 PP
|Defense priority

|Logothete
|80 PP
|CST only

|Drungarius
|40 PP
|Intel ops

|Eparch
|50 PP
|Infrastructure

|*Total*
|*450 PP*
|
|===
****

==== Phase 3: Execution & Feedback

.Iteration 1: Try to fulfill all requirements
****
* [x] 5 Destroyers built (200 PP)
* [x] 2 Frigates built (80 PP)
* [ ] 1 Starbase unfulfilled (need 40 PP)
* [x] CST research (80 PP)

*Feedback:* 1 Medium requirement unfulfilled +
*Action:* Continue to Iteration 2 (reprioritize)
****

.Iteration 2: Adjust and retry
****
* [ ] Starbase deferred (Low priority)
* [x] Add 1 Scout with remaining 40 PP

*Result:* Converged (no Critical/High unfulfilled)
****

==== Phase 4: Feedback to GOAP

.Update GOAP goal progress
****
*Goal 1:* "Defend Homeworld"

* [x] Turn 1/3 complete (5 Destroyers built)
* Progress: 33%

*Goal 2:* "Conquer System 42"

* [x] Turn 1/5 complete (2 Frigates built)
* Progress: 20%
****

== System Integration

=== Per-Turn Integration Flow

==== Phase 0: Intelligence (RBA)

.Drungarius → IntelligenceSnapshot
****
*Actions:*

* Update threat assessments
* Detect opportunities
* Track enemy construction

*Outputs:*

* → [To GOAP] World state update
* → [To RBA] Advisor distribution
****

==== Phase 1: Requirement Generation (RBA)

.All 6 advisors generate requirements
****
* Domestikos → BuildRequirements
* Logothete → ResearchRequirements
* Drungarius → EspionageRequirements
* Eparch → EconomicRequirements
* Protostrator → DiplomaticActions

*Output:*

* → [To GOAP] Extract strategic goals
****

==== Phase 1.5: Strategic Planning (GOAP)

.GOAP planner processes strategic goals
[example]
====
*Step 1: Goal Extraction*

* Parse requirements for strategic intent
* Identify multi-turn objectives
* Prioritize by urgency + strategic value

↓

*Step 2: Plan Generation (if needed)*

* For new goals → run A* planner
* For active goals → check progress
* Detect plan failures → trigger replan

↓

*Step 3: Cost Estimation*

* Per-turn budget needs for each goal
* Multi-turn resource reservations
* Priority weights for mediation

↓

*Output:*

* Active goals with current-turn actions
* Cost estimates per advisor
* Budget reservation requests
====

==== Phase 2: Mediation & Allocation (RBA + GOAP)

.Treasurer allocates budget with GOAP guidance
****
*Input:*

* RBA Requirements (from Phase 1)
* GOAP Guidance (from Phase 1.5)
* Treasury available

*Process:*

. Count Critical/High/Medium requirements
. Apply personality weights (Aggressive, Balanced, etc)
. Apply GOAP priority boost (goal-aligned requirements)
. Allocate PP proportionally

*Output:*

MultiAdvisorAllocation::
* budgets: Table[AdvisorType, int]
* reserved: int (for future turns)
****

==== Phase 3/4: Execution & Feedback (RBA)

.Iterative fulfillment (3 iterations max)
****
*Iteration 1:*

* [x] Process requirements with allocated budgets
* [x] Track fulfilled/unfulfilled per advisor
* [x] Check convergence (any Critical/High unfulfilled?)

*If unfulfilled Critical/High → Iteration 2:*

* [x] Reprioritize: downgrade expensive requirements
* [x] Substitute: suggest cheaper alternatives
* [x] Retry execution

*Output:* OrderPacket (ships, research, espionage, etc)
****

==== Phase 5: Feedback to GOAP (Bidirectional)

.RBA → GOAP
****
* Goal progress updates ("Built 5/10 Destroyers")
* Plan failures ("Couldn't afford Marines")
* Unexpected events ("Homeworld attacked!")
****

.GOAP → GOAP
****
* Update world state snapshot
* Check goal completion
* Trigger replanning if needed

*Replanning Triggers:*

* Goal failed (insufficient resources)
* Goal completed (mark success)
* Major threat detected (shift priorities)
* Opportunity appeared (add opportunistic goal)
* Plan stalled (>2 turns without progress)
****

== Information Flow

=== Vertical Flow: GOAP ↔ RBA Communication

==== GOAP → RBA (Downward Strategic Guidance)

.GOAP Strategic Layer
****
*Active Goals:*

* Goal A: "Defend homeworld" (Priority 90)
* Goal B: "Conquer System 42" (Priority 70)
* Goal C: "Research CST VI" (Priority 50)

↓ _Strategic Guidance Package_

Provides::
* Goal priorities
* Current-turn actions
* Cost estimates per advisor
* Budget reservations
* Goal-requirement alignment
****

.RBA Tactical Layer (Phase 1.5)
****
*Treasurer receives guidance:*

* Domestikos: 300 PP (Goal A)
* Logothete: 150 PP (Goal C)
* Reserve: 200 PP (Goal B Turn 2)
****

==== RBA → GOAP (Upward Execution Feedback)

.RBA Tactical Layer (Phase 4)
****
*Execution Results:*

* [x] 5 Destroyers built
* [x] 2 Frigates built
* [ ] 1 Carrier unfulfilled (no budget)
* [x] CST research started

↓ _Feedback Package_

Provides::
* Orders executed
* Goal progress (%)
* Failures & reasons
* Unexpected events
* Resource consumption
****

.GOAP Strategic Layer
****
*Update Goal States:*

* Goal A: 33% complete (on track)
* Goal B: 20% complete (delayed)
* Goal C: 10% complete (started)

*Replan Decision:* Continue (no issues)
****

=== Horizontal Flow: Advisor Coordination

==== Without GOAP (Current)

[example]
====
DOMESTIKOS → "Need 500 PP for Battleships"

↓

TREASURER → Mediation by personality only

↓

LOGOTHETE → "Need 300 PP for research"

*Result:* Independent competition, no strategic alignment
====

==== With GOAP (Future)

[example]
====
GOAP → "Goal: Build invasion fleet"

* Turn 1: 5 Destroyers
* Turn 2: 2 Carriers
* Turn 3: 10 Marines

↓

DOMESTIKOS → Requirements aligned with Goal (Destroyers prioritized)

↓

TREASURER → GOAP-weighted mediation (Goal priority boost)

↓

LOGOTHETE → Tech requirements coordinated (CST needed for Carriers)

*Result:* Strategic alignment, efficient coordination
====

== Decision Authority Matrix

=== Authority Distribution

[cols="2,1,1,2"]
|===
|Decision Type |GOAP Authority |RBA Authority |Resolution Method

|Long-term goals
|Full
|None
|GOAP decides

|Goal prioritization
|Full
|None
|GOAP scores

|Multi-turn plans
|Full
|None
|GOAP A* planner

|Budget strategy
|Guidance
|Input
|GOAP suggests

|Turn budget allocation
|Advisory
|Full
|Treasurer decides

|Build orders
|None
|Full
|Domestikos

|Research allocation
|None
|Full
|Logothete

|Fleet operations
|Strategic
|Tactical
|Both

|Emergency response
|Override
|Executes
|GOAP reprioritize

|Replanning triggers
|Full
|Feedback
|GOAP monitors
|===

=== Decision Flow Examples

==== Example 1: Strategic Goal "Conquer System 42"

.GOAP Decides
****
[x] *Goal:* "Conquer System 42" +
[x] *Priority:* 70 (High strategic value) +
[x] *Success probability:* 0.85

*Plan:*

* Turn 1: Build 5 Destroyers (200 PP)
* Turn 2: Build 2 Carriers (240 PP)
* Turn 3: Build 10 Marines (500 PP)
* Turn 4: Move fleet to System 42
* Turn 5: Invade System 42

↓ _(Strategic guidance)_
****

.RBA Executes
****
*Turn 1 (Domestikos):*

. Receive guidance: "Build 5 Destroyers for Goal X"
. Generate BuildRequirement(Destroyer, qty=5, priority=High)
. Treasurer allocates 200 PP
. Execute build orders
. Report back: "5 Destroyers commissioned"

*Turn 2 (Domestikos):*

. Receive guidance: "Build 2 Carriers for Goal X"
. Check prerequisites: Requires CST III [x] researched
. Generate BuildRequirement(Carrier, qty=2, priority=High)
. Treasurer allocates 240 PP
. Execute build orders
. Report back: "2 Carriers commissioned"

*Turns 3-5:* Continue execution...
****

==== Example 2: Emergency "Homeworld Under Attack"

.RBA Detects
****
*Turn 10 (Drungarius):*

* Intelligence: Enemy fleet (30 ships) approaching homeworld
* Threat level: Critical
* ETA: 2 turns

↓ _(Feedback to GOAP)_
****

.GOAP Responds
****
[x] *Replanning triggered:* Major threat detected +
[x] *Cancel Goals:* "Conquer System 42" (deferred) +
[x] *New Goal:* "Emergency Defense" (Priority 100) +
[x] *Budget override:* 100% treasury to defense

*New Plan:*

* Turn 10: Build 8 Frigates + 4 Starbases (max defense)
* Turn 11: Build 6 Destroyers + 2 Starbases
* Turn 12: Defensive posture, all fleets recall

↓ _(Strategic override)_
****

.RBA Executes
****
*Turn 10 (Domestikos):*

. Receive emergency guidance: "ALL BUDGET TO DEFENSE"
. Cancel all non-Critical requirements
. Generate emergency BuildRequirements:
** 8 Frigates (Critical, 320 PP)
** 4 Starbases (Critical, 160 PP)
. Treasurer allocates 100% treasury (480 PP)
. Execute emergency build orders
. Report back: "Emergency defenses in progress"
****

== Multi-Turn Planning

=== GOAP Plan Structure

.Multi-Turn Plan Anatomy
****
*Goal:* "Conquer System 42" +
*Priority:* 70 +
*Start Turn:* 5 +
*Completion Turn:* 10 +
*Success Probability:* 0.85 +
*Total Cost:* 940 PP
****

==== Turn-by-Turn Action Sequence

[cols="1,5"]
|===
|Turn |Actions

|5
a|*ACTION:* BuildFleet(Destroyer, qty=5)

Cost:: 200 PP
Precondition:: treasury ≥ 200 PP
Effect:: fleet_strength += 500
Assigned:: Domestikos

|6
a|*ACTION:* BuildFleet(Carrier, qty=2)

Cost:: 240 PP
Precondition:: CST ≥ III, treasury ≥ 240 PP
Effect:: carrier_capacity += 24 fighters
Assigned:: Domestikos

|7
a|*ACTION:* BuildGroundForces(Marine, qty=10)

Cost:: 500 PP
Precondition:: transport_capacity ≥ 10 PTU
Effect:: ground_strength += 1000
Assigned:: Domestikos

|8
a|*ACTION:* MoveFleet(invasion_fleet, System 42)

Cost:: 0 PP
Precondition:: path_exists, fleet_ready
Effect:: fleet_location = System 42
Assigned:: Domestikos (Phase 5)

|9
a|*ACTION:* AssembleInvasionForce()

Cost:: 0 PP
Precondition:: fleet + marines at System 42
Effect:: invasion_ready = true
Assigned:: Domestikos

|10
a|*ACTION:* InvadeSystem(System 42)

Cost:: 0 PP
Precondition:: invasion_ready = true
Effect:: owner(System 42) = self
Success:: 85% (based on combat strength)
Assigned:: Domestikos (Phase 3)
|===

==== Dependencies

[horizontal]
Turn 5 → 6:: Fleet built before carriers
Turn 6 → 7:: Carriers built before marines
Turn 7 → 8:: Marines built before movement
Turn 8 → 9:: Fleet moved before assembly
Turn 9 → 10:: Force assembled before invasion

=== Plan Tracking & Progress

.Goal: "Conquer System 42"
****
*Status:* IN PROGRESS (Turn 7/10)

[cols="1,3,1,1"]
|===
|Turn |Planned Action |Cost |Actual Status

|5
|Build 5 Destroyers
|200 PP
|[x] COMPLETE +
5/5 built

|6
|Build 2 Carriers
|240 PP
|[x] COMPLETE +
2/2 built

|7
|Build 10 Marines
|500 PP
|[ ] PARTIAL +
7/10 built (300 PP) +
_Issue: Treasury only had 300 PP_ +
_Replan: Defer 3 Marines to Turn 8_

|8
|[ADJUSTED] Build 3 Marines +
Move fleet to System 42
|150 PP +
0 PP
|[ ] PENDING

|9
|Assemble invasion force
|0 PP
|[ ] PENDING

|10
|Invade System 42
|0 PP
|[ ] PENDING
|===

*Progress:* 40% (2.5/5 actions complete) +
*Budget Consumed:* 500 PP / 940 PP (53%) +
*On Track:* DELAYED (1 turn behind)
****

== Feedback & Adaptation

=== Replanning Triggers

GOAP monitors 5 replanning conditions per turn:

==== Trigger 1: Goal Failed

.Condition: Goal cannot be completed with available resources
[example]
====
*Example:*

Goal:: "Build 10 Battleships"
Turn 5:: Treasury = 50 PP (need 2000 PP)
Trigger:: Insufficient treasury projection
Action:: Cancel goal or replan with cheaper units
====

==== Trigger 2: Major Threat Detected

.Condition: Critical threat to survival (homeworld, etc)
[example]
====
*Example:*

Turn 12:: Enemy invasion fleet approaching homeworld
Threat Level:: Critical (30 Battleships, ETA 2 turns)
Trigger:: Emergency defense required
Action:: Cancel all offensive goals, shift to defense
====

==== Trigger 3: Opportunity Appeared

.Condition: High-value target becomes available
[example]
====
*Example:*

Turn 8:: Intel reports System 15 undefended (5 PF system)
Opportunity:: Easy conquest (high prestige)
Trigger:: Add opportunistic goal
Action:: Insert "Conquer System 15" (Priority 60)
====

==== Trigger 4: Plan Stalled

.Condition: No progress on goal for 2+ consecutive turns
[example]
====
*Example:*

Goal:: "Research CST VI"
Turns 5-7:: 0 RP allocated (budget competition lost)
Trigger:: Stalled progress
Action:: Boost priority or defer goal
====

==== Trigger 5: Goal Completed

.Condition: Goal successfully achieved
[example]
====
*Example:*

Goal:: "Conquer System 42"
Turn 10:: System 42 captured (invasion success)
Trigger:: Goal complete
Action:: Remove goal, select next priority goal
====

=== Adaptation Flow

==== Adaptation Process (When Replan Triggered)

.Step 1: Detect Deviation
****
*GOAP compares:* Expected state vs Actual state

*Example:*

Expected:: 10 Marines built by Turn 7
Actual:: 7 Marines built (300 PP shortage)
Deviation:: -3 Marines (-30%)
****

.Step 2: Assess Impact
****
*Can goal still be achieved?*

* If yes: Adjust timeline (1 turn delay)
* If no: Replan or cancel goal

*Example:*

Marine shortage:: 3 Marines
Impact:: Invasion success drops 85% → 70%
Decision:: Acceptable (above 60% threshold)
Action:: Delay invasion 1 turn
****

.Step 3: Generate New Plan
****
*Re-run A* planner with updated constraints*

*New Plan:*

* Turn 8: Build 3 Marines (150 PP)
* Turn 9: Move fleet to System 42
* Turn 10: Assemble invasion force
* Turn 11: Invade System 42 (1 turn delay)
****

.Step 4: Update RBA Guidance
****
*Send revised guidance to RBA*

*Turn 8 Instructions:*

* Domestikos: Build 3 Marines (High priority)
* Treasurer: Allocate 150 PP for Marines
****

.Step 5: Continue Tracking
****
*Monitor revised plan execution*

* Update progress tracking
* Watch for new deviations
* Continue turn-by-turn adaptation
****

== Implementation Status

=== Current State (2025-12-10)

.Component Implementation Status
[cols="3,1,1"]
|===
|Component |Status |LOC

3+^h|*GOAP CORE*

|Types & data structures
|[x]
|150

|A* planner
|[x]
|400

|Heuristics
|[x]
|200

|Conditions
|[x]
|100

3+^h|*GOAP STATE*

|World state snapshots
|[x]
|200

|State assessment
|[x]
|150

|Action effects
|[x]
|100

3+^h|*GOAP DOMAINS (6 domains)*

|Fleet goals & actions
|[x]
|450

|Build goals & actions
|[x]
|400

|Research goals & actions
|[x]
|200

|Diplomatic goals & actions
|[x]
|200

|Espionage goals & actions
|[x]
|250

|Economic goals & actions
|[x]
|200

3+^h|*RBA-GOAP INTEGRATION*

|Goal extraction
|[x]
|200

|Plan tracking
|[x]
|150

|Replanning triggers
|[x]
|140

|Phase 1.5 entry point
|[x]
|280

|Budget guidance
|[~]
|40

|Feedback loops
|[~]
|40

3+^h|*RBA CORE (Production-Ready)*

|Basileus orchestrator
|[x]
|400

|6 Advisors (Domestikos, etc)
|[x]
|3,200

|Treasurer (CFO)
|[x]
|800

|5-Phase process
|[x]
|1,200

|Feedback loops
|[x]
|500

3+^h|*TOTAL* ~85% 2+^|*9,550*
|===

[horizontal]
[x]:: Complete and tested
[~]:: Implemented but needs enhancement
[ ]:: Not yet implemented

=== Integration Roadmap

==== Phase 1: GOAP Foundation [x] COMPLETE

[horizontal]
Date:: 2025-12-04
Status:: Production-ready, not yet integrated

*Deliverables:*

* [x] Core GOAP infrastructure (3,500 LOC)
* [x] 6 domain modules (Fleet, Build, Research, etc)
* [x] A* planner with confidence scoring
* [x] 35 unit tests (100% passing)

==== Phase 2: Basic Integration [x] COMPLETE

[horizontal]
Date:: 2025-12-04
Status:: Plumbing complete, guidance inactive

*Deliverables:*

* [x] Phase 1.5 entry point (280 LOC)
* [x] Goal extraction from requirements
* [x] Plan tracking data structures
* [x] Replanning trigger detection
* [x] AIController enhanced with GOAP fields

==== Phase 3: BUDGET GUIDANCE [X] COMPLETE

[horizontal]
Date:: 2025-12-10
Status:: 100% complete (multi-turn reservations active)

*Deliverables:*

* [X] GOAP cost estimates to Treasurer
* [X] Multi-turn budget reservations
* [X] Goal-aligned priority boosting
* [X] Strategic vs filler budget split (enhanced)

==== Phase 8.5: FEEDBACK LOOPS [X] COMPLETE

[horizontal]
Date:: 2025-12-20
Status:: Complete, further refinement in Phase 5

*Deliverables:*

* [X] RBA --> GOAP goal progress updates
* [X] GOAP reacts to detailed unfulfillment reasons (`TechNeeded`, `BudgetFailure`, `CapacityFull`)
* [X] Targeted GOAP goal generation based on feedback
* [X] Specific `ReplanReason` types for detailed feedback

==== Phase 5: FULL INTEGRATION (FUTURE) [ ] NOT STARTED

[horizontal]
Target:: 2026-Q1
Status:: Specification phase

*Deliverables:*

* [ ] Multi-turn coordination
* [ ] Cross-advisor dependencies
* [ ] Risk assessment integration
* [ ] Diagnostic visibility

==== Phase 6: NEURAL NETWORK TRAINING (FUTURE) [ ] NOT STARTED

[horizontal]
Target:: 2026-Q2
Status:: Planning phase

*Deliverables:*

* [ ] Export GOAP/RBA decisions as training data
* [ ] Train NN on GPU (desktop)
* [ ] NN learns from GOAP strategic patterns
* [ ] Hybrid NN/GOAP/RBA system

=== API Coverage

Based on `docs/api/api.json` (2025-12-10):

[horizontal]
Engine API:: 2,000+ exported procs
RBA API:: 85+ advisor procs
GOAP API:: 120+ planning procs

==== Key Entry Points

[source,nim]
----
src/ai/rba/player.nim::generateAIOrders()              # Main RBA entry
src/ai/rba/orders/phase1_5_goap.nim::runGOAPPlanning() # GOAP entry
src/ai/rba/controller.nim::newAIController()           # Initialization
----

== Summary

=== Key Principles

[arabic]
. *GOAP thinks, RBA acts* - Strategic planning vs tactical execution
. *Multi-turn vs single-turn* - GOAP plans 3-10 turns, RBA executes 1 turn
. *Goals guide requirements* - GOAP priorities inform RBA budget allocation
. *Feedback enables adaptation* - RBA reports progress, GOAP replans
. *Hybrid is stronger* - Combines long-term strategy with tactical expertise

=== Strengths of Hybrid System

[cols="2,1,1,1"]
|===
|Capability |GOAP Alone |RBA Alone |Hybrid GOAP/RBA

|Multi-turn planning
|[x]
|[ ]
|[x]

|Domain expertise
|[ ]
|[x]
|[x]

|Budget constraints
|[ ]
|[x]
|[x]

|Strategic foresight
|[x]
|[ ]
|[x]

|Emergency response
|[~]
|[ ]
|[x]

|Adaptive replanning
|[x]
|[~]
|[x]

|Cross-advisor coordination
|[ ]
|[~]
|[x]
|===

=== Next Steps

[arabic]
. *Complete Phase 3* - Full budget guidance integration (Treasurer enhanced)
. *Activate Phase 4* - Enable feedback loops (RBA → GOAP updates)
. *Validate with diagnostics* - Run 100-game balance tests
. *Tune GOAP parameters* - Optimize goal weights and replanning thresholds
. *Document for neural training* - Prepare GOAP/RBA decisions as NN training data

[appendix]
== Related Documentation

* link:goap-architecture.adoc[GOAP Architecture] - Full GOAP implementation details
* link:rba-decision-hierarchy.md[RBA Decision Hierarchy] - RBA advisor structure
* link:../mechanics/unit-progression.md[Unit Progression] - Game balance mechanics

---

*Maintained by:* AI Development Team

[NOTE]
====
*Document Format:* This document uses AsciiDoc with semantic features (example blocks, sidebar blocks, definition lists, admonition blocks) instead of ASCII art boxes. This format is:

* ✓ Readable in code editors (no alignment issues)
* ✓ AI-parseable (semantic structure)
* ✓ Human-friendly (clear hierarchy)
* ✓ Renders beautifully to HTML/PDF

Use this semantic approach for future architecture documents to maintain consistency and readability.
====
