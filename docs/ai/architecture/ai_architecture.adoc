= Hybrid GOAP/RBA AI Architecture
:doctype: book
:toc: left
:toclevels: 3
:sectnums:
:icons: font
:last-update-label!:

[.metadata]
****
*Last Updated:* 2025-12-12 +
*Status:* RBA Intelligence Unification COMPLETE (Phases 1-8) | GOAP MVP Deployed +
*System:* Byzantine Imperial AI with Strategic Planning Layer
****

== Executive Summary

The *Hybrid GOAP/RBA Architecture* combines two complementary AI systems:

=== GOAP (Goal-Oriented Action Planning) - Strategic Layer

*   Multi-turn goal planning (3-10 turn horizon)
*   Resource allocation strategies
*   Goal prioritization and replanning
*   High-level coordination

=== RBA (Rule-Based Advisors) - Tactical Layer

*   Turn-by-turn order generation
*   Budget-constrained fulfillment
*   Domain-specific expertise (6 advisors)
*   Iterative feedback loops

[IMPORTANT]
====
*Key Principle:* GOAP thinks strategically, RBA acts tactically.
====

=== System Overview

.Hybrid AI System Architecture
```mermaid
graph TD
    subgraph Hybrid AI System
        subgraph GOAP Strategic Layer (Multi-Turn Planning)
            A["Conquer System 42 in 5 turns"]
            B["Research CST VI by Turn 8"]
            C["Build invasion fleet (3 turns)"]
        end
        GOAP -->|Goals, Plans, Cost Estimates| RBA
        subgraph RBA Tactical Layer (Turn-by-Turn Execution)
            D["Build 2 Battleships this turn"]
            E["Allocate 300 PP to research"]
            F["Move Fleet 5 to System 42"]
        end
    end
```

---

== RBA Intelligence Unification (2025-12-12)

[IMPORTANT]
====
*Status:* COMPLETE - All 5 RBA advisors now use unified IntelligenceSnapshot +
*Impact:* Intelligence-driven decision making across all domains +
*Commits:* Phases 4-8 (5 commits, ~800 LOC added)
====

=== Overview

The RBA Intelligence Unification project (December 2025) transformed all 5 Byzantine advisors from heuristic-based to intelligence-driven decision making. This work addressed 36 intelligence gaps and eliminated architectural duplication between `controller.intelligence` and `house.intelligence`.

=== Architecture Changes

**Before (Pre-Unification):**
```
controller.intelligence: Table[SystemId, IntelligenceReport]  # 36 usage sites
house.intelligence: IntelligenceDatabase                       # Engine authoritative
→ Architectural duplication, sync issues, stale data
```

**After (Post-Unification):**
```
IntelligenceSnapshot (generated from house.intelligence each turn)
  ├── military: MilitaryIntelligence
  ├── economic: EconomicIntelligence
  ├── diplomatic: DiplomaticIntelligence
  ├── research: ResearchIntelligence
  └── espionage: EspionageIntelligence
→ Single source of truth, DRY principle, fresh intelligence
```

=== Implementation Phases (Dec 2025)

==== Phase 4: Domestikos (Military Advisor) Enhancements

**File:** `src/ai/rba/domestikos/`

**Enhancements:**
* **Fleet Composition Analysis** - Uses detailed fleet intelligence vs single strength number
* **Defensive Capability Assessment** - Analyzes ground batteries, shields, starbases, orbiting fleets
* **Predictive Defense Allocation** - Uses fleet movement tracking to detect approaching threats
* **Combat Doctrine Adaptation** - Adjusts ROE based on observed enemy behavior (Aggressive/Defensive/Raiding/Balanced)

**New Module:** `combat_doctrine_adapter.nim` (125 lines)

**Key Functions:**
```nim
proc adaptTacticsToEnemyDoctrine*(enemyHouse, intelSnapshot) -> ROERecommendation
  # Counters: Aggressive → Defensive, Defensive → Aggressive, Raiding → Pursuit
```

==== Phase 5: Drungarius (Intelligence Advisor) Enhancements

**File:** `src/ai/rba/drungarius/requirements.nim`

**Enhancements:**
* **Multi-Factor Espionage Targeting** - 5-factor scoring (tech value, economic value, military threat, CI weakness, diplomatic weight)
* **Counter-Intelligence Assessment** - Proactive response to detected espionage (emergency CIP boost + sweeps)
* **Economic Intelligence for Sabotage** - Targets bottlenecks (shipyard concentrations, construction choke points)

**Key Functions:**
```nim
proc scoreEspionageTarget*(...) -> EspionageTargetScore  # 5-factor analysis
proc assessCounterIntelligenceNeeds*(...) -> seq[EspionageRequirement]
proc selectSabotageBottlenecks*(...) -> seq[SabotageTarget]
```

**Intelligence-Driven Changes:**
* Espionage targets selected by strategic value, not just prestige
* Counter-intel operations triggered by detection risk levels
* Sabotage prioritizes high-value chokepoints (shipyards, construction hubs)

==== Phase 6: Logothete (Research Advisor) Enhancements

**Files:**
* `src/ai/rba/logothete/requirements.nim` (enhanced)
* `src/ai/rba/logothete/counter_tech.nim` (new, 140 lines)

**Enhancements:**
* **Competitive Research Strategy** - Uses urgent research needs, tech gaps, tech advantages
* **Threat-Responsive Research** - Prioritizes combat tech when under attack
* **Counter-Tech Selection** - Reactive research to counter enemy advantages

**New Module:** `counter_tech.nim`

**Key Functions:**
```nim
proc selectCounterTech*(enemyHouse, enemyTechLevels, ourTechLevels, intelSnapshot) -> seq[CounterTechRecommendation]
  # 5 counter strategies:
  # 1. Counter Superior Weapons → Match their weapons
  # 2. Counter Superior CST → Match construction tech (gates units)
  # 3. Counter Strong Economy → Use ELI (Electronic Intelligence)
  # 4. Counter Espionage → Use CIC (Counter-Intelligence)
  # 5. Counter Advanced Fighters → Match fighter doctrine
```

**Intelligence-Driven Changes:**
* Research priorities driven by competitive intelligence (gaps/advantages)
* Counter-tech automatically selected for top 2 threats per enemy
* Threat-responsive: Weapons prioritized when under critical threat (not shields - shields are planetary only)

==== Phase 7: Eparch (Economic Advisor) Enhancements

**Files:**
* `src/ai/rba/eparch/requirements.nim` (threat-aware facilities)
* `src/ai/rba/eparch/economic_requirements.nim` (competitive assessment)

**Enhancements:**

**7.1: Blockade Prediction - Threat-Aware Infrastructure**
* Enhanced all facility selection functions (Shipyard, Spaceport, Starbase)
* **Threat penalties:**
  - Critical: 80-90% penalty (avoid building in combat zones)
  - High: 50-70% penalty (risky location)
  - Moderate: 20-30% penalty (slight risk)
* **Staleness penalty:** 10-15% for blind spots (unknown risk)
* **Starbases get heavier penalties** (90% for Critical) due to high cost

**7.2: Enemy Infrastructure Intelligence - Competitive Assessment**
* Created `assessCompetitiveEconomicPosition()` - analyzes relative economic strength
* **Flags economic pressure** if producing <70% of average enemy
* **Infrastructure priority boost:** 1.5-2.0x when significantly behind
* Compares: production output, shipyard counts, economic capabilities

**7.3: Centralized Expansion Management (ETAC Fleets)**
* **Responsibility shifted from Tactical/Domestikos to Eparch**
* Eparch now generates all colonization orders for ETAC fleets in Phase 1
* Handles new ETAC construction requirements as part of economic planning
* Ensures aggressive, parallel colonization in Act 1 ("Land Grab")
* Aligns expansion with economic strategy (not military)

**Key Functions:**
```nim
proc findBestShipyardColony*(..., intelSnapshot) -> Option[SystemId]
  # Applies threat penalties, avoids threatened colonies
proc assessCompetitiveEconomicPosition*(ourHouse, intelSnapshot) -> EconomicCompetitiveAssessment
  # productionRatio, enemyShipyardAdvantage, infrastructurePriorityBoost
```

**Intelligence-Driven Changes:**
* Infrastructure placement considers threat levels (avoid building in war zones)
* Economic strategy responds to competitive pressure (boost when behind)
* No more expensive starbases in threatened colonies
* **ETAC fleet management centralized under Eparch** (economic expansion, not military)

==== Phase 8: Protostrator (Diplomatic Advisor) Enhancements

**File:** `src/ai/rba/protostrator/assessment.nim`

**Enhancements:**

**8.1: Enemy Relations Intelligence - Enemies Under Pressure**
* Created `identifyEnemiesUnderPressure()` - finds distracted/vulnerable enemies
* Analyzes: wars, diplomatic breaks, combat activity, hostility levels
* **Opportunity score:** Fighting on multiple fronts = vulnerable
* **Use cases:**
  - Domestikos: Target distracted enemies for attack
  - Drungarius: Opportunistic espionage when enemies busy
  - Protostrator: Diplomatic escalation timing

**8.2: Impending Attack Detection - Diplomatic Urgency Assessment**
* Created `assessDiplomaticUrgency()` - detects attack warning signs
* **6 threat indicators tracked:**
  1. Fleet buildup near borders (CRITICAL)
  2. Recent scouting activity (war preparation)
  3. Espionage activity (hostile intentions)
  4. Military capability growth (rapid buildup)
  5. Diplomatic hostility escalation (Aggressive posture)
  6. Existing diplomatic state (already at war)
* **5-level urgency scoring:** None/Low/Moderate/High/Critical
* Provides specific indicators and recommended actions

**Key Functions:**
```nim
proc identifyEnemiesUnderPressure*(filtered, intelSnapshot) -> seq[tuple[houseId, distractedBy, opportunityScore]]
proc assessDiplomaticUrgency*(filtered, intelSnapshot) -> seq[ThreatIndicator]
  # Returns: source, urgency (Critical/High/Moderate/Low), indicators, recommendedAction
```

**Intelligence-Driven Changes:**
* Diplomatic decisions based on threat assessment (not just personality)
* Attack timing considers enemy distractions (fighting on multiple fronts)
* Defensive diplomacy prioritized when threat indicators detected

=== Impact Summary

**Code Changes:**
* **5 commits** (Phases 4-8)
* **~800 lines added** across 8 files
* **3 new modules created** (combat_doctrine_adapter, counter_tech, competitive assessment)
* **All pre-commit checks passing** ✅

**Intelligence Usage:**
* **36 intelligence gaps addressed**
* **Deprecated:** `controller.intelligence` (architectural duplication eliminated)
* **Unified:** All advisors use `IntelligenceSnapshot` from `house.intelligence`
* **Domain coverage:** Military, Economic, Diplomatic, Research, Espionage

**Decision Making Improvements:**
* **Domestikos:** Threat-aware defense, doctrine-based tactics
* **Drungarius:** Strategic espionage targeting, proactive counter-intel
* **Logothete:** Competitive research, counter-tech strategies
* **Eparch:** Threat-aware infrastructure, competitive economic response
* **Protostrator:** Attack detection, enemy pressure exploitation

**Expected Behavioral Changes:**
* More strategic infrastructure placement (avoid threatened colonies)
* Better economic competition (respond to enemy production advantages)
* Smarter military timing (attack distracted enemies)
* Improved threat awareness (detect fleet buildups and escalations)
* Proactive counter-intelligence (respond to espionage pressure)
* Research priorities driven by competitive landscape
* **More aggressive and coordinated early-game expansion** driven by Eparch

---

== Dynamic 4-Act Strategic Progression

The AI's strategic focus is governed by a 4-act structure. To make the AI more responsive to the state of the galaxy, the progression between acts is determined by dynamic gates rather than fixed turn counts. This ensures the AI's strategy adapts to the pace of each unique game.

=== Progression Gates

|===
| Transition | Gate Condition | Rationale

| *Act 1 → Act 2*
| The map becomes 90% colonized.
| The initial "land grab" phase is over. Focus shifts from expansion to consolidation and conflict over existing territory.

| *Act 2 → Act 3*
| A major power is eliminated. (Top 3 house by prestige at the start of Act 2)
| The elimination of a significant player destabilizes the galaxy, signaling the start of large-scale, decisive warfare.

| *Act 3 → Act 4*
| One house controls over 50% of the total prestige on the map.
| A clear leader has emerged. The game enters its final phase where the leader tries to secure victory and others may form a coalition to stop them.
|===

=== Advisor Priorities by Act

The priorities of the Byzantine advisors are weighted differently in each act to reflect the overall strategic goal.

.Act 1: Land Grab (Focus: Expansion & Reconnaissance)
[cols="1,1,3"]
|===
| Advisor | Priority | Rationale

| *Eparch* (Economy)
| `CRITICAL`
| Drive aggressive colonization. Build Spaceports and Shipyards in parallel across all colonies to create a robust ETAC production pipeline.

| *Domestikos* (Military)
| `HIGH`
| Build cheap, fast ships (e.g., Destroyers) for exploration and intelligence gathering. Avoid combat unless necessary.

| *Drungarius* (Intel)
| `MEDIUM`
| Map out nearby systems to find valuable colonization targets and identify neighbor locations.

| *Logothete* (Research)
| `MEDIUM`
| Focus on technologies that accelerate expansion: Construction (for facilities) and Propulsion (for fleet speed).

| *Protostrator* (Diplomacy)
| `LOW`
| Establish contact with other houses but remain neutral. Avoid early conflicts that would slow down expansion.
|===

.Act 2: Rising Tensions (Focus: Consolidation & Military Buildup)
[cols="1,1,3"]
|===
| Advisor | Priority | Rationale

| *Domestikos* (Military)
| `CRITICAL`
| Construct a credible combat fleet to secure borders and deter aggression. Consolidate forces and establish defensive positions.

| *Eparch* (Economy)
| `HIGH`
| Shift from expansion to economic consolidation. Build defensive Starbases on key worlds and invest in industrial capacity (IU).

| *Logothete* (Research)
| `HIGH`
| Prioritize key military technologies (Weapons, Shields, Armor) to prepare for the inevitable conflict.

| *Drungarius* (Intel)
| `MEDIUM`
| Shift focus from exploration to espionage. Assess the military capabilities and intentions of potential threats.

| *Protostrator* (Diplomacy)
| `MEDIUM`
| Form defensive pacts and alliances to create a stable power bloc. Isolate aggressive neighbors.
|===

.Act 3: Total War (Focus: Conquest)
[cols="1,1,3"]
|===
| Advisor | Priority | Rationale

| *Domestikos* (Military)
| `CRITICAL`
| Wage decisive wars to eliminate rivals. Plan and execute large-scale invasions of enemy core worlds.

| *Drungarius* (Intel)
| `HIGH`
| Provide detailed tactical intelligence for invasions. Sabotage enemy war production and disrupt logistics.

| *Protostrator* (Diplomacy)
| `HIGH`
| Manage war alliances, coordinate joint operations, and attempt to break enemy coalitions through diplomatic pressure.

| *Eparch* (Economy)
| `MEDIUM`
| Manage a full war economy. Focus production on replacing combat losses and supporting massive invasion fleets.

| *Logothete* (Research)
| `MEDIUM`
| Research advanced, high-tier combat technologies to gain a decisive battlefield advantage.
|===

.Act 4: Endgame (Focus: Securing Victory)
[cols="1,1,3"]
|===
| Advisor | Priority | Rationale

| *Domestikos* (Military)
| `CRITICAL`
| Eliminate the last remaining rivals to secure a military victory or protect the lead against "last stand" attacks.

| *Eparch* (Economy)
| `HIGH`
| Maximize prestige generation from all available sources to accelerate a prestige victory.

| *Protostrator* (Diplomacy)
| `HIGH`
| Diplomatically isolate the leading player or, if leading, secure alliances to prevent a coalition from forming.

| *Logothete* (Research)
| `MEDIUM`
| Focus on very high-cost, game-ending technologies that provide significant prestige or military power.

| *Drungarius* (Intel)
| `MEDIUM`
| Defend against last-ditch espionage efforts and provide intelligence on the final victory push.
|===

---

== Integrating GOAP for Strategic Coordination (Developer Guide)

This section outlines the steps required to transition the GOAP system from its current "observation-only" state to a fully integrated strategic layer that actively directs the RBA's tactical execution.

=== Step 1: Enabling GOAP in Observation Mode

The GOAP planner can be enabled or disabled via the RBA configuration file.

. Open `config/rba.toml`.
. Navigate to the `[goap]` section.
. Set `enabled = true`.

When enabled, the AI will execute **Phase 1.5** (`executePhase15_GOAP`) on each turn. In this mode, it will:
- Extract strategic goals from the current game state.
- Generate multi-turn plans to achieve those goals.
- Track plan progress (which will stall, as no actions are taken).
- Log its activity for analysis.

*Result:* GOAP runs in the background, generating plans without affecting RBA behavior. This is useful for diagnostics and validating the planner's logic.

=== Step 2: Activating GOAP Budget Guidance

To make GOAP influence the RBA, its strategic budget estimates must guide the Treasurer's allocation.

. **Modify Basileus Mediation (`src/ai/rba/basileus/mediation.nim`):**
.. The `mediateAndAllocateBudget` procedure needs to be updated.
.. It should retrieve the `goapBudgetEstimates` from the `AIController`.
.. These estimates provide a per-advisor budget target (e.g., "Domestikos needs 500PP this turn for the invasion plan").
.. The Basileus should use these estimates to apply a strong priority boost to RBA requirements that align with active GOAP goals.

*Result:* The Treasurer's budget allocation will shift to support the RBA advisors whose requirements are necessary for the current multi-turn strategic plan. For example, if GOAP has an active "Conquer System" plan, Domestikos (military) will receive a larger share of the budget for ship construction.

=== Step 3: Activating GOAP Plan Execution

To translate GOAP's plans into concrete actions, a conversion step is needed. GOAP plans are abstract sequences of actions; the RBA needs concrete `BuildOrder` and `FleetOrder` objects.

. **Implement GOAP->RBA Order Conversion:**
.. Create a new procedure or expand `plan_tracking.executeAllPlans`.
.. This procedure will iterate through the active GOAP plan's actions for the current turn.
.. It will convert abstract actions (e.g., `BuildFleet(Destroyer, 5)`) into specific RBA orders (`BuildOrder` for 5 Destroyers).
.. These orders should be injected into the main order packet with a high priority.

. **Integrate into the Main Order Loop (`src/ai/rba/orders.nim`):**
.. The orders generated by GOAP plan execution (`Phase 6.5`) should be given precedence.
.. The tactical fleet order generation (`Phase 7`) should be aware of fleets already assigned tasks by GOAP to avoid conflicts. This can be achieved by passing a set of GOAP-controlled fleet IDs to `generateFleetOrders`.

*Result:* The AI's actions will now be driven by the multi-turn strategy. Instead of the RBA making purely tactical, single-turn decisions, its actions (building ships, moving fleets) will be steps in a larger, coherent plan devised by GOAP.

=== Step 4: Closing the Feedback Loop

For GOAP to adapt its plans, it needs detailed feedback from the RBA on what was actually accomplished.

. **Enhance GOAP Progress Reporting (`src/ai/rba/orders/phase4_feedback.nim`):**
.. The `reportGOAPProgress` procedure needs to be fully implemented.
.. It must compare the RBA's `MultiAdvisorAllocation` result with the GOAP plan's actions for the turn.
.. It should report successes, failures (e.g., budget shortfalls preventing a build), and partial progress.
.. This feedback updates the `PlanTracker`, which is the core of the replanning system.

*Result:* GOAP becomes truly adaptive. If the RBA fails to execute a step in the plan (e.g., due to an unexpected enemy attack forcing a budget shift), GOAP will detect the deviation in the next turn, trigger a replan, and generate a new, more relevant strategy.

=== Expected Outcome of Full Integration

When fully integrated, the AI will exhibit significantly more intelligent and coordinated behavior:
- **Strategic Coherence:** Ship construction, fleet movements, and research will be aligned toward a single, multi-turn objective.
- **Improved Resource Management:** The AI will save resources across turns to achieve expensive, long-term goals (e.g., building a capital ship fleet).
- **Adaptability:** The AI will abandon or modify plans that are no longer viable and pivot to exploit new opportunities, all without manual scripting.

---

== Architecture Overview

=== Two-Layer Decision Hierarchy

```mermaid
graph TD
    subgraph Strategic Horizon (3-10 turns)
        subgraph GOAP Layer
            Goals --> Planner(A* Search)
            Planner --> Plans(Multi-turn)
            subgraph Inputs
                WorldState(World State)
                Opportunities
                Threats
            end
            WorldState --> Goals
            Opportunities --> Goals
            Threats --> Goals
            Plans --> ActionSequences(Action Sequences)
            Plans --> CostEstimates(Cost Estimates)
            Plans --> Dependencies
        end
    end
    GOAPLayer -->|Strategic Guidance: Active goals, Plan progress, Cost budgets| RBALayer
    subgraph Tactical Horizon (1 turn)
        subgraph RBA Layer
            Basileus(Basileus <br> (Turn Coordinator))
            Basileus --- Drung(Drung. <br> (Intel))
            Basileus --- Treasurer(Treasurer <br> (CFO))
            Basileus --- Dom(Domestikos <br> (Military))
            Treasurer --- Logo(Logo. <br> (R&D))
            Treasurer --- Eparch(Eparch <br> (Economy))
            Treasurer --- Proto(Proto. <br> (Diplo.))
        end
    end
```

### Responsibility Split

| Layer    | Responsibility      | Time Horizon | Decision Type     |
|----------|---------------------|--------------|-------------------|
| **GOAP** | What to achieve     | 3-10 turns   | Strategic goals   |
| **GOAP** | How to sequence     | Multi-turn   | Action planning   |
| **GOAP** | When to replan      | Continuous   | Adaptive strategy |
| **RBA**  | How to execute      | 1 turn       | Tactical orders   |
| **RBA**  | What to build       | 1 turn       | Resource alloc    |
| **RBA**  | Where to move       | 1 turn       | Fleet operations  |

---

== Strategic vs Tactical Decision Making

=== GOAP: Strategic Planning (Multi-Turn)

**Purpose:** Answer "What should we achieve in the next 5 turns?"

==== Step 1: Goal Extraction

.Analyze world state and extract strategic goals
```
Input: GameState, Intelligence, Advisor Requirements
Output: Prioritized goal list

Example Goals:
- Priority 90: "Defend Homeworld (critical)"
- Priority 70: "Conquer System 42"
- Priority 50: "Research CST VI"
- Priority 30: "Expand to 5 colonies"
```

==== Step 2: Plan Generation (A* Search)

.For each goal, generate action sequence
```
Goal: "Conquer System 42"

|===
|Turn |Action |Cost

|1
|Build 5 Destroyers
|200 PP

|2
|Build 2 Carriers
|240 PP

|3
|Build 10 Marines
|500 PP

|4
|Move to System 42
|0 PP

|5
|Invade System 42
|0 PP
|===

Total Cost: 940 PP over 5 turns
Success Probability: 0.85
```

==== Step 3: Cost Estimation & Prioritization

.Evaluate feasibility and rank goals
```
Ranking Criteria:
- Strategic value (survival > expansion)
- Cost efficiency (PP per prestige point)
- Success probability (threat assessment)
- Time to completion (urgent > deferred)

Final Plan:
- [X] Goal 1: Defend Homeworld  (500 PP, 3 turns)
- [X] Goal 2: Conquer System 42 (940 PP, 5 turns)
- [ ] Goal 3: CST VI (deferred, insufficient PP)
```

==== Step 4: Tactical Handoff to RBA

.Provide current-turn guidance to RBA advisors
```
Turn 1 Instructions:
- Domestikos: Build 5 Destroyers (Goal 1)
- Domestikos: Build 2 Frigates (Goal 2)
- Treasurer: Reserve 700 PP for Turn 2-3
- Logothete: Defer CST VI research
```

### RBA: Tactical Execution (Single-Turn)

**Purpose:** Answer "What should we do THIS turn?"

==== Phase 0: Intelligence Distribution

.Drungarius collects fog-of-war intelligence
```
- Threats: Enemy fleet at System 15 (20 ships)
- Opportunities: System 42 undefended
- Construction: Enemy building Battleships
```

==== Phase 1: Requirement Generation

.Each advisor generates THIS TURN requirements
```
Domestikos:
- Build 5 Destroyers (Critical, 200 PP)
- Build 2 Frigates (High, 80 PP)
- Build 1 Starbase (Medium, 40 PP)

Logothete:
- Research CST (Medium, 150 PP)
- Research ACO (Low, 100 PP)

Total Requested: 570 PP
Treasury Available: 450 PP
--> OVER BUDGET (need Phase 2 mediation)
```

==== Phase 1.5: GOAP Guidance (Optional)

.GOAP informs budget allocation priorities
```
Active Goals:
  Goal 1 (Priority 90): "Defend Homeworld"
    --> Boost Domestikos defense requirements
  Goal 2 (Priority 70): "Conquer System 42"
    --> Reserve 240 PP for Turn 2 carriers

Budget Guidance:
  Strategic: 360 PP (80%)
  Filler: 90 PP (20%)
  Reserved: 240 PP (next turn)
```

==== Phase 2: Mediation & Allocation

.Treasurer allocates PP budget across advisors
```
Allocation (GOAP-informed):
- Domestikos: 280 PP (defense priority)
- Logothete: 80 PP (CST only)
- Drungarius: 40 PP (intel ops)
- Eparch: 50 PP (infrastructure)
- Total: 450 PP
```

==== Phase 3: Execution & Feedback

.Iteration 1: Try to fulfill all requirements
```
- [X] 5 Destroyers built (200 PP)
- [X] 2 Frigates built (80 PP)
- [ ] 1 Starbase unfulfilled (need 40 PP)
- [X] CST research (80 PP)

Feedback: 1 Medium requirement unfulfilled
--> Continue to Iteration 2 (reprioritize)

Iteration 2: Adjust and retry
- [ ] Starbase deferred (Low priority)
- [X] Add 1 Scout with remaining 40 PP

Result: Converged (no Critical/High unfulfilled)
```

==== Phase 4: Feedback to GOAP

.Update GOAP goal progress
```
Goal 1: "Defend Homeworld"
- [X] Turn 1/3 complete (5 Destroyers built)
- Progress: 33%

Goal 2: "Conquer System 42"
- [X] Turn 1/5 complete (2 Frigates built)
- Progress: 20%
```

---

== System Integration

### Per-Turn Integration Flow

```mermaid
graph TD
    subgraph AI Turn Cycle
        A[Start Turn N] --> P0(Phase 0: Intelligence Distribution);
        P0 --> P1(Phase 1: Multi-Advisor Requirement Generation);
        P1 --> P1_5(Phase 1.5: GOAP Strategic Planning);
        P1_5 --> P2(Phase 2: Mediation & Budget Allocation);
        P2 --> P3(Phase 3: Requirement Execution - Non-Iterative);
        P3 --> P3_4(Phase 3/4: Unified Feedback Loop - Iterative Execution & Reprioritization);
        P3_4 --> P5(Phase 5: Strategic Operations Planning);
        P5 --> P6(Phase 6: Standing Orders Assignment);
        P6 --> P7(Phase 7: Tactical Fleet Orders);
        P7 --> P7_5(Phase 7.5: Colony Management);
        P7_5 --> P8(Phase 8: Logistics Optimization);
        P8 --> P8_5(Phase 8.5: Report GOAP Progress);
        P8_5 --> Z[End Turn N / Start Turn N+1];
    end
```

```
DETAILED PER-TURN EXECUTION FLOW
================================

+------------------------------------------------------------------------------------+
| PHASE 0: INTELLIGENCE DISTRIBUTION (Drungarius, `generateIntelligenceSnapshot`)    |
+------------------------------------------------------------------------------------+
| Input: FilteredGameState, AIController                                             |
| Output: IntelligenceSnapshot (stored in AIController)                              |
| Process: Consolidates all visible game state information for internal AI use,      |
|          respecting Fog of War. Updates threat assessments, opportunities.         |
+------------------------------------------------------------------------------------+
                                         |
                                         v
+------------------------------------------------------------------------------------+
| PHASE 1: MULTI-ADVISOR REQUIREMENT GENERATION (`generateAllAdvisorRequirements`)   |
+------------------------------------------------------------------------------------+
| Input: AIController, FilteredGameState, IntelligenceSnapshot                       |
| Output: Advisor-specific Requirement objects (stored in AIController)              |
| Process: Each of the 6 advisors generates a list of prioritized requirements       |
|          (e.g., build ships, research tech, conduct espionage) for the turn.       |
|          GOAP's active plans influence these requirements, boosting priorities.    |
+------------------------------------------------------------------------------------+
                                         |
                                         v
+------------------------------------------------------------------------------------+
| PHASE 1.5: GOAP STRATEGIC PLANNING (`executePhase15_GOAP`)                         |
+------------------------------------------------------------------------------------+
| Input: AIController, FilteredGameState, IntelligenceSnapshot                       |
| Output: Updated AIController.goapPlanTracker, GOAP budget estimates for Treasurer  |
| Process:                                                                           |
|  - GOAL EXTRACTION: Identify strategic goals from the current world state.         |
|  - PRIORITY REASSESSMENT: Dynamically adjust goal priorities based on game context.|
|  - TARGETED GOAL INJECTION: If replanning, add specific high-priority goals (e.g., |
|   `AchieveTechLevel` for `TechNeeded` failure, `GainTreasury` for `BudgetFailure`).|
|  - PLAN GENERATION/REPAIR: Creates new multi-turn plans for goals, or attempts     |
|    `repairPlan` for failed/stalled plans using detailed feedback.                  |
|  - BUDGET ESTIMATION: Provides GOAP's estimated costs for each domain to Treasurer.|
+------------------------------------------------------------------------------------+
                                         |
                                         v
+------------------------------------------------------------------------------------+
| PHASE 2: BASILEUS MEDIATION & BUDGET ALLOCATION (`mediateAndAllocateBudget`)       |
+------------------------------------------------------------------------------------+
| Input: AIController, FilteredGameState, all Advisor Requirements, GOAP estimates   |
| Output: MultiAdvisorAllocation (stored in AIController.lastTurnAllocationResult)   |
| Process:                                                                           |
|  - BASILEUS MEDIATION: Weights all requirements by `AIPersonality`, `GameAct`,     |
|    and GOAP priority boosts. Resolves conflicts.                                   |
|  - TREASURER ALLOCATION: Reserves minimum budgets (recon, expansion), then         |
|    distributes remaining PP/RP/EBP/CIP based on weighted requirements.             |
|  - DETAILED FEEDBACK: Generates `RequirementFeedback` for unfulfilled              |
|    requirements, including specific reasons and suggestions for GOAP/RBA.          |
+------------------------------------------------------------------------------------+
                                         |
                                         v
+------------------------------------------------------------------------------------+
| PHASE 3: REQUIREMENT EXECUTION (Non-Iterative Orders)                              |
+------------------------------------------------------------------------------------+
| Input: AIController, FilteredGameState, MultiAdvisorAllocation                     |
| Output: Partial OrderPacket (research, espionage, terraform, diplomatic actions)   |
| Process: Converts initially allocated budgets and fulfilled requirements into      |
|          orders for research, espionage, terraforming, and diplomacy.              |
+------------------------------------------------------------------------------------+
                                         |
                                         v
+------------------------------------------------------------------------------------+
| PHASE 3/4: UNIFIED FEEDBACK LOOP (Iterative Execution & Reprioritization)          |
+------------------------------------------------------------------------------------+
| Input: AIController, FilteredGameState, MultiAdvisorAllocation                     |
| Output: Finalized Build Orders, potentially adjusted other orders                  |
| Process: (Up to 3 iterations)                                                      |
|  - EXECUTION: All advisor order execution procedures (including build orders) run. |
|  - CONVERGENCE CHECK: `hasUnfulfilledCriticalOrHigh` checks if high-priority       |
|    requirements remain unfulfilled from the Treasurer's feedback.                  |
|  - REPRIORITIZATION: If unfulfilled, `reprioritizeAllAdvisors` modifies advisor    |
|    requirements using detailed Treasurer feedback.                                 |
|  - RE-ALLOCATION/RE-EXECUTION: Budget is re-allocated and orders re-executed       |
|    with adjusted priorities until convergence or iteration limit reached.          |
+------------------------------------------------------------------------------------+
                                         |
                                         v
+------------------------------------------------------------------------------------+
| PHASE 5: STRATEGIC OPERATIONS PLANNING (`identifyInvasionOpportunities`)           |
+------------------------------------------------------------------------------------+
| Input: AIController, FilteredGameState                                             |
| Output: CoordinatedOperation objects (for GOAP planning)                           |
| Process: Identifies high-level strategic opportunities for military operations     |
|          (e.g., vulnerable enemy colonies for invasion) and queues them for GOAP.  |
+------------------------------------------------------------------------------------+
                                         |
                                         v
+------------------------------------------------------------------------------------+
| PHASE 6: STANDING ORDERS ASSIGNMENT (`assignStandingOrders`)                       |
+------------------------------------------------------------------------------------+
| Input: AIController, FilteredGameState                                             |
| Output: Updated AIController.standingOrders, Logistics build requirements          |
| Process: Assigns persistent routine orders to fleets (e.g., `AutoRepair`,          |
|          `AutoColonize`, `DefendSystem`). Includes intelligent Drydock selection   |
|          for `AutoRepair`. Logistics-generated build requirements (e.g., Drydocks) |
|          are added to Domestikos' requirements.                                    |
+------------------------------------------------------------------------------------+
                                         |
                                         v
+------------------------------------------------------------------------------------+
| PHASE 7: TACTICAL FLEET ORDERS (`generateFleetOrders`)                             |
+------------------------------------------------------------------------------------+
| Input: AIController, FilteredGameState                                             |
| Output: Tactical FleetOrder objects                                                |
| Process: Generates explicit movement and combat orders for non-routine or          |
|          offensive fleet operations, overriding standing orders.                   |
+------------------------------------------------------------------------------------+
                                         |
                                         v
+------------------------------------------------------------------------------------+
| PHASE 7.5: COLONY MANAGEMENT (`generateColonyManagementOrders`)                    |
+------------------------------------------------------------------------------------+
| Input: AIController, FilteredGameState                                             |
| Output: ColonyManagementOrder objects                                              |
| Process: Manages colony-specific settings (e.g., tax rates, auto-repair flags).    |
+------------------------------------------------------------------------------------+
                                         |
                                         v
+------------------------------------------------------------------------------------+
| PHASE 8: LOGISTICS OPTIMIZATION (`generateLogisticsOrders`)                        |
+------------------------------------------------------------------------------------+
| Input: AIController, FilteredGameState                                             |
| Output: ZeroTurnCommands (cargo, squadrons), PopulationTransferOrders, FleetOrders |
| Process: Optimizes use of existing assets: cargo, population transfers, fleet      |
|          lifecycle (Salvage, Mothball, Reactivate), and Drydock management.        |
+------------------------------------------------------------------------------------+
                                         |
                                         v
+------------------------------------------------------------------------------------+
| PHASE 8.5: REPORT GOAP PROGRESS (RBA -> GOAP Feedback, `generateFeedback`)         |
+------------------------------------------------------------------------------------+
| Input: AIController, MultiAdvisorAllocation, GameEvents                            |
| Output: Updated AIController.goapPlanTracker, `controller.replanNeeded` flag       |
| Process:                                                                           |
|  - PROGRESS REPORTING: Matches RBA outcomes to GOAP actions; uses `GameEvent`s     |
|    to verify success/failure (`checkActualOutcome`). Stores detailed feedback.     |
|  - REPLANNING TRIGGERS: `checkGOAPReplanningNeeded` assesses plan health, detects  |
|    opportunities, and sets a flag for next turn's GOAP planning if needed.         |
*Output*: Updated `AIController.goapPlanTracker` state, and a flag (`replanNeeded`) to trigger replanning in the subsequent turn.
```

---

== Information Flow

### Vertical Flow: GOAP <--> RBA Communication

==== GOAP → RBA (Downward Strategic Guidance)

.GOAP Strategic Layer
```
+-----------------------------------------+
|         GOAP STRATEGIC LAYER            |
|                                         |
|  Active Goals:                          |
|   Goal A: "Defend homeworld" (Pri 90)   |
|   Goal B: "Conquer Sys 42" (Pri 70)     |
|   Goal C: "Research CST VI" (Pri 50)    |
+---------------+-------------------------+
                |
                | Strategic Guidance Package
                | +-----------------------------+
                | | - Goal priorities           |
                | | - Current-turn actions      |
                | | - Cost estimates per advisor|
                | | - Budget reservations       |
                | | - Goal-requirement alignment|
                | +-----------------------------+
                v
+-----------------------------------------+
|     RBA TACTICAL LAYER (Phase 1.5)      |
|                                         |
|  Treasurer receives guidance:           |
|   - Domestikos: 300 PP (Goal A)         |
|   - Logothete: 150 PP (Goal C)          |
|   - Reserve: 200 PP (Goal B Turn 2)     |
+-----------------------------------------+
```

==== RBA → GOAP (Upward Execution Feedback)

.RBA Tactical Layer (Phase 8.5)
```
+-----------------------------------------+
|     RBA TACTICAL LAYER (Phase 8.5)      |
|                                         |
|  Execution Results:                     |
|   [X] 5 Destroyers built                |
|   [X] 2 Frigates built                  |
|   [ ] 1 Carrier unfulfilled (no budget) |
|   [X] CST research started              |
+---------------+-------------------------+
                |
                | Feedback Package
                | +-----------------------------+
                | | - Orders executed           |
                | | - Goal progress (%)         |
                | | - Failures & reasons        |
                | | - Unexpected events         |
                | | - Resource consumption      |
                | +-----------------------------+
                v
+-----------------------------------------+
|         GOAP STRATEGIC LAYER            |
|                                         |
|  Update Goal States:                    |
|   Goal A: 33% complete (on track)       |
|   Goal B: 20% complete (delayed)        |
|   Goal C: 10% complete (started)        |
|                                         |
|  Replan Decision: Continue (no issues)  |
+-----------------------------------------+
```

### Horizontal Flow: Advisor Coordination

==== Without GOAP (Initial RBA)

```
+-----------------------------------------+
|           DOMESTIKOS                    |---> "Need 500 PP for Battleships"
+-----------------------------------------+
                |
                v
+-----------------------------------------+
|            TREASURER                    |---> Mediation by personality only
+-----------------------------------------+
                |
                v
+-----------------------------------------+
|            LOGOTHETE                    |---> "Need 300 PP for research"
+-----------------------------------------+

Result: Independent competition, no strategic alignment
```

==== With GOAP (Current Hybrid System)

```
+-----------------------------------------+
|              GOAP                       |---> "Goal: Build invasion fleet"
+------+----------------------------------+         |
       |                            Turn 1: 5 Destroyers
       |                            Turn 2: 2 Carriers
       |                            Turn 3: 10 Marines
       v
+-----------------------------------------+
|           DOMESTIKOS                    |---> Requirements aligned with Goal
+-----------------------------------------+         (Destroyers prioritized)
                |
                v
+-----------------------------------------+
|            TREASURER                    |---> GOAP-weighted mediation
+-----------------------------------------+         (Goal priority boost)
                |
                v
+-----------------------------------------+
|            LOGOTHETE                    |---> Tech requirements coordinated
+-----------------------------------------+         (CST needed for Carriers)

Result: Strategic alignment, efficient coordination
```

---

== Decision Authority Matrix

### Authority Distribution

| Decision Type          | GOAP Authority | RBA Authority | Resolution Method |
|------------------------|----------------|---------------|-------------------|
| Long-term goals        | Full           | None          | GOAP decides      |
| Goal prioritization    | Full           | None          | GOAP scores       |
| Multi-turn plans       | Full           | None          | GOAP A* planner   |
| Budget strategy        | Guidance       | Input         | GOAP suggests     |
| Turn budget allocation | Advisory       | Full          | Treasurer decides |
| Build orders           | None           | Full          | Domestikos        |
| Research allocation    | None           | Full          | Logothete         |
| Fleet operations       | Strategic      | Tactical      | Both              |
| Emergency response     | Override       | Executes      | GOAP reprioritize |
| Replanning triggers    | Full           | Feedback      | GOAP monitors     |

### Decision Flow Examples

#### Example 1: Strategic Goal "Conquer System 42"

```
GOAP DECIDES:
-------------
[X] Goal: "Conquer System 42"
[X] Priority: 70 (High strategic value)
[X] Plan:
   Turn 1: Build 5 Destroyers (200 PP)
   Turn 2: Build 2 Carriers (240 PP)
   Turn 3: Build 10 Marines (500 PP)
   Turn 4: Move fleet to System 42
   Turn 5: Invade System 42
[X] Success probability: 0.85

      |
      | (Strategic guidance)
      v

RBA EXECUTES:
-------------
[X] Turn 1 (Domestikos):
   - Receive guidance: "Build 5 Destroyers for Goal X"
   - Generate BuildRequirement(Destroyer, qty=5, priority=High)
   - Treasurer allocates 200 PP
   - Execute build orders
   - Report back: "5 Destroyers commissioned"

[X] Turn 2 (Domestikos):
   - Receive guidance: "Build 2 Carriers for Goal X"
   - Check prerequisites: Requires CST III [X] researched
   - Generate BuildRequirement(Carrier, qty=2, priority=High)
   - Treasurer allocates 240 PP
   - Execute build orders
   - Report back: "2 Carriers commissioned"

[X] Turns 3-5: Continue execution...
```

#### Example 2: Emergency "Homeworld Under Attack"

```
RBA DETECTS:
------------
[X] Turn 10 (Drungarius):
   - Intelligence: Enemy fleet (30 ships) approaching homeworld
   - Threat level: Critical
   - ETA: 2 turns

      |
      | (Feedback to GOAP)
      v

GOAP RESPONDS:
--------------
[X] Replanning triggered: Major threat detected
[X] Cancel Goals: "Conquer System 42" (deferred)
[X] New Goal: "Emergency Defense" (Priority 100)
[X] New Plan:
   Turn 10: Build 8 Frigates + 4 Starbases (max defense)
   Turn 11: Build 6 Destroyers + 2 Starbases
   Turn 12: Defensive posture, all fleets recall
[X] Budget override: 100% treasury to defense

      |
      | (Strategic override)
      v

RBA EXECUTES:
-------------
[X] Turn 10 (Domestikos):
   - Receive emergency guidance: "ALL BUDGET TO DEFENSE"
   - Cancel all non-Critical requirements
   - Generate emergency BuildRequirements:
     * 8 Frigates (Critical, 320 PP)
     * 4 Starbases (Critical, 160 PP)
   - Treasurer allocates 100% treasury (480 PP)
   - Execute emergency build orders
   - Report back: "Emergency defenses in progress"
```

---

## Multi-Turn Planning

### GOAP Plan Structure

```
MULTI-TURN PLAN ANATOMY
========================

Goal: "Conquer System 42"
Priority: 70
Start Turn: 5
Completion Turn: 10
Success Probability: 0.85
Total Cost: 940 PP

+--------------------------------------------------------------+
| TURN-BY-TURN ACTION SEQUENCE                                 |
+------+-------------------------------------------------------+
| Turn | Actions                                               |
+------+-------------------------------------------------------+
|  5   | +---------------------------------------------------+ |
|      | | ACTION: BuildFleet(Destroyer, qty=5)              | |
|      | | Cost: 200 PP                                      | |
|      | | Precondition: treasury >= 200 PP                  | |
|      | | Effect: fleet_strength += 500                     | |
|      | | Assigned: Domestikos                              | |
|      | +---------------------------------------------------+ |
+------+-------------------------------------------------------+
|  6   | +---------------------------------------------------+ |
|      | | ACTION: BuildFleet(Carrier, qty=2)                | |
|      | | Cost: 240 PP                                      | |
|      | | Precondition: CST >= III, treasury >= 240 PP      | |
|      | | Effect: carrier_capacity += 24 fighters           | |
|      | | Assigned: Domestikos                              | |
|      | +---------------------------------------------------+ |
+------+-------------------------------------------------------+
|  7   | +---------------------------------------------------+ |
|      | | ACTION: BuildGroundForces(Marine, qty=10)         | |
|      | | Cost: 500 PP                                      | |
|      | | Precondition: transport_capacity >= 10 PTU        | |
|      | | Effect: ground_strength += 1000                   | |
|      | | Assigned: Domestikos                              | |
|      | +---------------------------------------------------+ |
+------+-------------------------------------------------------+
|  8   | +---------------------------------------------------+ |
|      | | ACTION: MoveFleet(invasion_fleet, System 42)      | |
|      | | Cost: 0 PP                                        | |
|      | | Precondition: path_exists, fleet_ready            | |
|      | | Effect: fleet_location = System 42                | |
|      | | Assigned: Domestikos (Phase 5)                    | |
|      | +---------------------------------------------------+ |
+------+-------------------------------------------------------+
|  9   | +---------------------------------------------------+ |
|      | | ACTION: AssembleInvasionForce()                   | |
|      | | Cost: 0 PP                                        | |
|      | | Precondition: fleet + marines at System 42        | |
|      | | Effect: invasion_ready = true                     | |
|      | | Assigned: Domestikos                              | |
|      | +---------------------------------------------------+ |
+------+-------------------------------------------------------+
| 10   | +---------------------------------------------------+ |
|      | | ACTION: InvadeSystem(System 42)                   | |
|      | | Cost: 0 PP                                        | |
|      | | Precondition: invasion_ready = true               | |
|      | | Effect: owner(System 42) = self                   | |
|      | | Success: 85% (based on combat strength)           | |
|      | | Assigned: Domestikos (Phase 3)                    | |
|      | +---------------------------------------------------+ |
+------+-------------------------------------------------------+

DEPENDENCIES:
=============
Turn 5 -> Turn 6: Fleet built before carriers
Turn 6 -> Turn 7: Carriers built before marines
Turn 7 -> Turn 8: Marines built before movement
Turn 8 -> Turn 9: Fleet moved before assembly
Turn 9 -> Turn 10: Force assembled before invasion
```

### Plan Tracking & Progress

```
PLAN PROGRESS TRACKING
=======================

Goal: "Conquer System 42"
Status: IN PROGRESS (Turn 7/10)

+------+----------------------------------------+--------------+
| Turn | Planned Action                         | Actual Status|
+------+----------------------------------------+--------------+
|  5   | Build 5 Destroyers (200 PP)            | [X] COMPLETE |
|      |                                        |   5/5 built  |
+------+----------------------------------------+--------------+
|  6   | Build 2 Carriers (240 PP)              | [X] COMPLETE |
|      |                                        |   2/2 built  |
+------+----------------------------------------+--------------+
|  7   | Build 10 Marines (500 PP)              | [ ] PARTIAL  |
|      |                                        |   7/10 built |
|      |                                        |   (300 PP)   |
|      | Issue: Treasury only had 300 PP        |              |
|      | Replan: Defer 3 Marines to Turn 8      |              |
+------+----------------------------------------+--------------+
|  8   | [ADJUSTED] Build 3 Marines (150 PP)    | [ ] PENDING  |
|      | Move fleet to System 42                | [ ] PENDING  |
+------+----------------------------------------+--------------+
|  9   | Assemble invasion force                | [ ] PENDING  |
+------+----------------------------------------+--------------+
| 10   | Invade System 42                       | [ ] PENDING  |
+------+----------------------------------------+--------------+

Progress: 40% (2.5/5 actions complete)
Budget Consumed: 500 PP / 940 PP (53%)
On Track: DELAYED (1 turn behind)
```

---

## Feedback & Adaptation

### Replanning Triggers

```
REPLANNING TRIGGER SYSTEM
==========================

GOAP monitors 5 replanning conditions per turn:

+--------------------------------------------------------------+
| TRIGGER 1: GOAL FAILED                                       |
+--------------------------------------------------------------+
| Condition: Goal cannot be completed with available resources |
|                                                              |
| Example:                                                     |
|   Goal: "Build 10 Battleships"                               |
|   Turn 5: Treasury = 50 PP (need 2000 PP)                    |
|   Trigger: Insufficient treasury projection                  |
|   Action: Cancel goal or replan with cheaper units           |
+--------------------------------------------------------------+

+--------------------------------------------------------------+
| TRIGGER 2: MAJOR THREAT DETECTED                             |
+--------------------------------------------------------------+
| Condition: Critical threat to survival (homeworld, etc)      |
|                                                              |
| Example:                                                     |
|   Turn 12: Enemy invasion fleet approaching homeworld        |
|   Threat Level: Critical (30 Battleships, ETA 2 turns)       |
|   Trigger: Emergency defense required                        |
|   Action: Cancel all offensive goals, shift to defense       |
+--------------------------------------------------------------+

+--------------------------------------------------------------+
| TRIGGER 3: OPPORTUNITY APPEARED                              |
+--------------------------------------------------------------+
| Condition: High-value target becomes available               |
|                                                              |
| Example:                                                     |
|   Turn 8: Intel reports System 15 undefended (5 PF system)   |
|   Opportunity: Easy conquest (high prestige)                 |
|   Trigger: Add opportunistic goal                            |
|   Action: Insert "Conquer System 15" (Priority 60)           |
+--------------------------------------------------------------+

+--------------------------------------------------------------+
| TRIGGER 4: PLAN STALLED                                      |
+--------------------------------------------------------------+
| Condition: No progress on goal for 2+ consecutive turns      |
|                                                              |
| Example:                                                     |
|   Goal: "Research CST VI"                                    |
|   Turns 5-7: 0 RP allocated (budget competition lost)        |
|   Trigger: Stalled progress                                  |
|   Action: Boost priority or defer goal                       |
+--------------------------------------------------------------+

+--------------------------------------------------------------+
| TRIGGER 5: GOAL COMPLETED                                    |
|                                                              |
| Example:                                                     |
|   Goal: "Conquer System 42"                                  |
|   Turn 10: System 42 captured (invasion success)             |
|   Trigger: Goal complete                                     |
|   Action: Remove goal, select next priority goal             |
+--------------------------------------------------------------+
```

### Adaptation Flow

```
ADAPTATION PROCESS (When Replan Triggered)
===========================================

STEP 1: DETECT DEVIATION
+-------------------------------------------------+
| GOAP compares:                                  |
|   Expected state vs Actual state                |
|                                                 |
| Example:                                        |
|   Expected: 10 Marines built by Turn 7          |
|   Actual: 7 Marines built (300 PP shortage)     |
|   Deviation: -3 Marines (-30%)                  |
+-------------------------------------------------+
                         |
                         v
STEP 2: ASSESS IMPACT
+-------------------------------------------------+
| Can goal still be achieved?                     |
|   - If yes: Adjust timeline (1 turn delay)      |
|   - If no: Replan or cancel goal                |
|                                                 |
| Example:                                        |
|   Marine shortage: 3 Marines                    |
|   Impact: Invasion success drops 85% -> 70%     |
|   Decision: Acceptable (above 60% threshold)    |
|   Action: Delay invasion 1 turn                 |
+-------------------------------------------------+
                         |
                         v
STEP 3: GENERATE NEW PLAN
+-------------------------------------------------+
| Re-run A* planner with updated constraints      |
|                                                 |
| New Plan:                                       |
|   Turn 8: Build 3 Marines (150 PP)              |
|   Turn 9: Move fleet to System 42               |
|   Turn 10: Assemble invasion force              |
|   Turn 11: Invade System 42 (1 turn delay)      |
+-------------------------------------------------+
                         |
                         v
STEP 4: UPDATE RBA GUIDANCE
+-------------------------------------------------+
| Send revised guidance to RBA                    |
| Turn 8 Instructions:                            |
|   Domestikos: Build 3 Marines (High priority)   |
|   Treasurer: Allocate 150 PP for Marines        |
+-------------------------------------------------+
                         |
                         v
STEP 5: CONTINUE TRACKING
+-------------------------------------------------+
| Monitor revised plan execution                  |
|   - Update progress tracking                    |
|   - Watch for new deviations                    |
|   - Continue turn-by-turn adaptation            |
+-------------------------------------------------+
```

---

## Implementation Status

### Current State (2025-12-10 - MVP DEPLOYED)

```
COMPONENT IMPLEMENTATION STATUS (MVP)
=====================================

+-----------------------------------------+----------+----------+
| Component                               |  Status  |   LOC    |
+-----------------------------------------+----------+----------+
| GOAP CORE (MVP)                         |          |          |
|  - Types & data structures              |    [X]   |   150    |
|  - A* planner (Fleet + Build only)      |    [X]   |   280    |
|  - Heuristics (basic)                   |    [~]   |   200    |
|  - Conditions (simplified)              |    [~]   |   100    |
|                                         |          |          |
| GOAP STATE (MVP)                        |          |          |
|  - World state snapshots                |    [X]   |   200    |
|  - State assessment (basic)             |    [~]   |   150    |
|  - Action effects (Fleet + Build)       |    [~]   |    50    |
|                                         |          |          |
| GOAP DOMAINS (2 of 6 implemented)       |          |          |
|  - Fleet goals & actions (MVP)          |    [X]   |   250    |
|  - Build goals & actions (MVP)          |    [X]   |   200    |
|  - Research goals & actions             |    [D]   |   200    |
|  - Diplomatic goals & actions           |    [D]   |   200    |
|  - Espionage goals & actions            |    [D]   |   250    |
|  - Economic goals & actions             |    [D]   |   200    |
|  - Repair/Drydock goals & actions       |    [D]   |    50    |
|  - Prestige goals & actions             |    [D]   |    50    |
|  - Endgame/Elimination goals & actions  |    [D]   |    50    |
|                                         |          |          |
| RBA-GOAP INTEGRATION (MVP)              |          |          |
|  - Goal extraction (Fleet + Build)      |    [X]   |   200    |
|  - Plan tracking (simplified)           |    [X]   |   150    |
|  - Replanning triggers (basic)          |    [X]   |   140    |
|  - Phase 1.5 entry point                |    [X]   |   280    |
|  - Budget guidance (observation only)   |    [~]   |   100    |
|  - Feedback loops (Phase 8.5, basic)    |    [X]   |    60    |
|  - Order conversion (RBA->GOAP)         |    [D]   |     0    |
|  - Advanced replanning                  |    [D]   |     0    |
|                                         |          |          |
| RBA CORE (Production-Ready)             |          |          |
|  - Basileus orchestrator                |    [X]   |   400    |
|  - 6 Advisors (Domestikos, etc)         |    [X]   |  3,200   |
|  - Treasurer (CFO)                      |    [X]   |   800    |
|  - 9-Phase process (0-8.5)              |    [X]   |  1,200   |
|  - Feedback loops (RBA internal)        |    [X]   |   500    |
+-----------------------------------------+----------+----------+
| MVP TOTAL                               |   40%    |  7,360   |
| FULL IMPLEMENTATION TARGET              |  100%    | 13,500   |
+-----------------------------------------+----------+----------+

Legend:
  [X] = Complete and tested in MVP
  [~] = Implemented but simplified/basic
  [D] = Deferred to post-MVP
  [ ] = Not yet implemented

### Integration Roadmap

```
INTEGRATION PHASES
==================

PHASE 1: GOAP FOUNDATION [X] COMPLETE
--------------------------------------
[X] Core GOAP infrastructure (3,500 LOC)
[X] 6 domain modules (Fleet, Build, Research, etc)
[X] A* planner with confidence scoring
[X] 35 unit tests (100% passing)

Date: 2025-12-04
Status: Production-ready, not yet integrated


PHASE 2: BASIC INTEGRATION [X] COMPLETE
---------------------------------------
[X] Phase 1.5 entry point (280 LOC)
[X] Goal extraction from requirements
[X] Plan tracking data structures
[X] Replanning trigger detection
[X] AIController enhanced with GOAP fields

Date: 2025-12-04
Status: Plumbing complete, guidance inactive


PHASE 3: BUDGET GUIDANCE [~] MVP COMPLETE
------------------------------------------
[X] GOAP cost estimates calculated
[~] Budget guidance (observation only, not yet influencing Treasurer)
[D] Multi-turn budget reservations (deferred to post-MVP)
[D] Goal-aligned priority boosting (deferred to post-MVP)

Date: 2025-12-10
Status: MVP complete - GOAP generates budget estimates but doesn't influence RBA yet


PHASE 8.5: FEEDBACK LOOPS [~] MVP COMPLETE
-------------------------------------------
[X] Basic plan tracking (activePlans, completedPlans)
[X] Stall detection and replanning triggers
[D] RBA → GOAP goal progress updates (deferred to post-MVP)
[D] Detailed unfulfillment reason handling (deferred to post-MVP)
[D] Targeted GOAP goal generation based on feedback (deferred to post-MVP)

Date: 2025-12-10
Status: MVP complete - simplified tracking only, no detailed feedback integration


Gap 1: GOAP's Direct Actionability of Detailed Feedback [D] DEFERRED TO POST-MVP
------------------------------------------------------------------------------------
**MVP Status**: Infrastructure exists but not yet connected. `RequirementFeedback` with `unfulfillmentReason` is generated by Treasurer, and `PlanTracker` has fields for storing failure reasons, but the feedback loop from RBA to GOAP replanning is not yet implemented.

**Deferred Tasks**:
- Integrating `RequirementFeedback` into GOAP replanning logic
- Implementing `repairPlan` procedure for targeted goal injection
- Adding context-aware replanning (e.g., `AchieveTechLevel` for `TechNeeded`)

Status: Deferred to Post-MVP


Gap 2: Espionage Goal Generation and Execution Depth [D] DEFERRED TO POST-MVP
--------------------------------------------------------------------------------
**MVP Status**: Espionage domain exists (250 LOC of goal/action definitions) but is not integrated into Phase 1.5 goal extraction or plan generation.

**Deferred Tasks**:
- Integrating espionage goals into GOAP planning
- Connecting GOAP espionage actions to RBA `Drungarius` requirements
- Testing espionage plan execution and feedback

Status: Deferred to Post-MVP


Gap 3: Advanced Plan Repair [D] DEFERRED TO POST-MVP
------------------------------------------------------
**MVP Status**: Basic replanning trigger exists (stall detection), but no partial plan repair or continuation logic implemented.

**Deferred Tasks**:
- Implementing `repairPlan` procedure for late-stage failures
- Adding partial plan regeneration from current world state
- Testing plan repair vs. full replanning efficiency

Status: Deferred to Post-MVP


Gap 4: Dynamic Goal/Priority Adjustment [D] DEFERRED TO POST-MVP
------------------------------------------------------------------
**MVP Status**: Goals are generated with static priorities from config. No dynamic reassessment based on evolving game state.

**Deferred Tasks**:
- Implementing `reassessGoalPriorities` procedure
- Integrating personality-based priority adjustments
- Testing dynamic priority changes in response to threats/opportunities

Status: Deferred to Post-MVP


Gap 5: Comprehensive Repair Planning and Drydock Management [D] DEFERRED TO POST-MVP
--------------------------------------------------------------------------------------
**MVP Status**: Repair/Drydock domain exists (50 LOC) but not integrated into planning.

**Deferred Tasks**:
- Integrating repair goals into GOAP planning
- Connecting to RBA logistics and standing orders
- Testing automated drydock management

Status: Deferred to Post-MVP


Gap 6: Proactive Prestige Management [D] DEFERRED TO POST-MVP
---------------------------------------------------------------
**MVP Status**: Prestige domain exists (50 LOC) but not integrated.

**Deferred Tasks**:
- Integrating `MaintainPrestige` goal into planning
- Connecting to RBA advisor prestige-aware logic
- Testing prestige penalty avoidance and exploitation

Status: Deferred to Post-MVP


Gap 7: Endgame & Elimination Strategy [D] DEFERRED TO POST-MVP
----------------------------------------------------------------
**MVP Status**: Endgame domain exists (50 LOC) but not integrated.

**Deferred Tasks**:
- Integrating `AchieveTotalVictory` and `LastStandReconquest` goals
- Adjusting diplomatic requirements for endgame scenarios
- Testing endgame strategy transitions

Status: Deferred to Post-MVP


### MVP STATUS SUMMARY (2025-12-10)

**Implemented Features:**
- ✅ A* Planner for Fleet + Build domains only
- ✅ AIController integration (7 GOAP fields active)
- ✅ Phase 1.5 entry point (goal extraction and plan generation)
- ✅ Phase 8.5 feedback loop (simplified tracking)
- ✅ Diagnostic integration (5 GOAP metrics in CSV output)
- ✅ Configuration system ([goap] section in rba.toml)
- ✅ Plan tracking (activePlans, completedPlans)
- ✅ Replanning triggers (stall detection after N turns)

**Deferred to Post-MVP:**
- ❌ Research, Diplomatic, Espionage, Economic, Repair, Prestige, Endgame domains
- ❌ GOAP → RBA order conversion (plans generated but not executed)
- ❌ Budget guidance integration (estimates calculated but don't influence Treasurer)
- ❌ Advanced replanning with detailed feedback (RequirementFeedback → GOAP)
- ❌ Complex condition/effect implementations
- ❌ Multi-turn budget reservations
- ❌ Goal-aligned priority boosting
- ❌ Dynamic goal priority reassessment
- ❌ Partial plan repair

**Testing Results:**
- ✅ Baseline test (GOAP disabled): 5 turns, no crashes
- ✅ Integration test (GOAP enabled): 5 turns, plan generation working
- ✅ Phase 1.5 executes: "GOAP: Extracted N goals", "GOAP: Generated M plans"
- ✅ Phase 8.5 executes: "GOAP: X active, Y completed", replanning triggers
- ✅ Planning overhead: ~0.02ms per house per turn (negligible)
- ✅ Diagnostics: 5 GOAP metrics present in CSV output

**Known Limitations:**
1. **Goal extraction returns 0 goals** in early game - expected behavior as FleetGoals and BuildGoals require specific conditions (undefended colonies, idle fleets, etc.)
2. **Plans marked as stalled** after N turns - normal for observation-only mode since plans aren't converted to RBA orders
3. **GOAP Reserved=0PP** in budget allocation - budget guidance not yet influencing Treasurer
4. **No visible gameplay impact** - GOAP is in observation mode, generates plans but RBA doesn't execute them

**Next Steps (Post-MVP):**
1. GOAP → RBA order conversion (Phase 4.5)
2. Budget guidance integration (Phase 3 enhancement)
3. Advanced replanning with RequirementFeedback (Gap 1)
4. Research + Diplomatic domains (expand beyond Fleet + Build)
5. Multi-plan dependencies and coordination


PHASE 5: FULL INTEGRATION (FUTURE) [ ] NOT STARTED
---------------------------------------------------
[ ] Multi-turn coordination
[ ] Cross-advisor dependencies
[ ] Risk assessment integration
[ ] Diagnostic visibility

Target: 2026-Q1
Status: Specification phase


PHASE 6: NEURAL NETWORK TRAINING (FUTURE) [ ] NOT STARTED
----------------------------------------------------------
[ ] Export GOAP/RBA decisions as training data
[ ] Train NN on GPU (desktop)
[ ] NN learns from GOAP strategic patterns
[ ] Hybrid NN/GOAP/RBA system

Target: 2026-Q2
Status: Planning phase
```

---

### API Coverage

Based on `docs/api/api.json` (2025-12-10):

**Engine API:** 2,000+ exported procs
**RBA API:** 85+ advisor procs
**GOAP API:** 120+ planning procs

**Key Entry Points:**
- `src/ai/rba/player.nim::generateAIOrders()` - Main RBA entry
- `src/ai/rba/orders/phase1_5_goap.nim::runGOAPPlanning()` - GOAP entry
- `src/ai/rba/controller.nim::newAIController()` - Initialization

---

## Summary

### Key Principles

1. **GOAP thinks, RBA acts** - Strategic planning vs tactical execution
2. **Multi-turn vs single-turn** - GOAP plans 3-10 turns, RBA executes 1 turn
3. **Goals guide requirements** - GOAP priorities inform RBA budget allocation
4. **Feedback enables adaptation** - RBA reports progress, GOAP replans
5. **Hybrid is stronger** - Combines long-term strategy with tactical expertise

### Strengths of Hybrid System

| Capability              | GOAP Alone | RBA Alone | Hybrid GOAP/RBA |
|-------------------------|------------|-----------|-----------------|
| Multi-turn planning     | [X]        | [ ]       | [X]             |
| Domain expertise        | [ ]        | [X]       | [X]             |
| Budget constraints      | [ ]        | [X]       | [X]             |
| Strategic foresight     | [X]        | [ ]       | [X]             |
| Emergency response      | [X]        | [X]       | [X]             |
| Adaptive replanning     | [X]        | [X]       | [X]             |
| Cross-advisor coord     | [X]        | [X]       | [X]             |

### Next Steps

1. **Phase 5: Full Integration** - Implement multi-turn coordination, cross-advisor dependencies, risk assessment, and diagnostic visibility.
2. **Phase 6: Neural Network Training** - Export GOAP/RBA decisions as training data, train NN, and develop a fully hybrid NN/GOAP/RBA system.
3. **Phase 7: Event-Based Reactive Behavior** - Add GameEvent subscription system to RBA for mid-turn reactive behavior (see TODO below).
4. **Validate with diagnostics** - Run 100-game balance tests.
5. **Tune GOAP parameters** - Optimize goal weights and replanning thresholds.

### TODO: Rich Narrative Events & Hybrid Reports System

**Status:** Partial Implementation (Espionage only) - Broader system deferred to Post-MVP

**Vision:** Implement comprehensive GameEvents system per `docs/guides/GameEvents_Guide.md` to enable rich hybrid reports (state + narrative) across all game systems.

**Current State (2025-12-11):**
- ✅ **Espionage events implemented:** `scoutColonyIntelGathered`, `scoutSystemIntelGathered`, `scoutStarbaseIntelGathered`
- ✅ Scout intelligence gathering populates intelligence database (fixed 2025-12-11)
- ❌ **Combat events:** Basic only, lacks round-by-round narrative
- ❌ **Fleet movement events:** Basic only, lacks detailed movement/encounter narrative
- ❌ **Construction events:** No events for ship commissioning, building completion
- ❌ **Diplomatic events:** No events for relation changes, treaty actions
- ❌ **Economic events:** No events for trade, resource milestones
- ❌ **RBA event subscription:** AI doesn't react to GameEvents during resolution

**GameEvents Guide Pattern (Hybrid Reports):**

Per guide lines 108-160, players need **state + events** for meaningful reports:

**Example: Combat Reports**
```
State (aftermath):           Events (narrative):
- 2 ships destroyed          → Round 1: Destroyer hit by railgun (42 dmg)
- Fleet damaged              → Round 2: Frigate destroyed by missiles
- Victory achieved           → Round 3: Cruiser retreat triggered
```

**Example: Turn Summary**
```
State (current):             Events (what happened):
- Colony at 75% factory      → Fleet Alpha: Engaged at Rigel IV (Victory)
- 4.2M population            → Scout Beta: Gathered intel on enemy
- Tech tree progress         → Construction: Battleship commissioned
```

**Missing Event Types Needed:**

**1. Combat Events** (Guide lines 42-72)
```nim
- WeaponFiredEvent(attacker, weapon, target, damage, hit)
- ShipDamagedEvent(ship, damage, remaining_hp, weapon_type)
- ShipDestroyedEvent(ship, killed_by, overkill_damage)
- CombatPhaseCompletedEvent(phase, rounds, victor, casualties)
- FleetRetreatEvent(fleet, reason, casualties)
```

**2. Fleet Operations Events** (Guide lines 20-23)
```nim
- FleetMovementBeganEvent(fleet, origin, destination, eta)
- FleetMovementCompletedEvent(fleet, location, encounters)
- FleetEncounterEvent(fleet, enemy_fleet, location)
- FleetOrderAbortedEvent(fleet, order_type, reason)
- FleetMergedEvent(fleet_a, fleet_b, resulting_fleet)
```

**3. Construction Events**
```nim
- ShipCommissionedEvent(ship_class, colony, turn_completed)
- BuildingCompletedEvent(building_type, colony, bonus_granted)
- ConstructionQueueUpdatedEvent(colony, queue_depth, eta)
- TechResearchCompletedEvent(tech, research_time, benefits)
```

**4. Economic Events**
```nim
- ResourceMilestoneEvent(resource_type, threshold_crossed)
- TradeRouteEstablishedEvent(from_colony, to_colony, value)
- EconomicCrisisEvent(house, treasury_deficit, impact)
- ColonyDevelopedEvent(colony, infrastructure_level)
```

**5. Diplomatic Events**
```nim
- DiplomaticRelationChangedEvent(house_a, house_b, old_state, new_state, reason)
- TreatyProposedEvent(proposer, recipient, treaty_type)
- TreatyAcceptedEvent(house_a, house_b, treaty_type, duration)
- TreatyBrokenEvent(breaker, victim, treaty_type, prestige_penalty)
```

**Implementation Priorities:**

**Phase 7a: Combat Narrative Events** (High Priority)
- Combat is most visible, players want detailed reports
- Current reports lack "how did I win/lose?" narrative
- Implement weapon hit/miss, ship destruction, phase completion events
- Enable round-by-round combat logs

**Phase 7b: Fleet Operations Events** (Medium Priority)
- Movement, encounters, mergers
- "Where did my fleet go?" clarity
- Retreat reasons, order failures

**Phase 7c: Economic/Construction Events** (Medium Priority)
- Ship commissioning notifications
- Tech completion milestones
- Building completion updates

**Phase 7d: Diplomatic Events** (Lower Priority)
- Relation changes with explanations
- Treaty proposals/acceptances/breaks

**Phase 7e: RBA Event Subscription** (After events implemented)
- AI subscribes to filtered events
- Reactive behavior during resolution
- Dynamic priority adjustments
- Opportunistic decision-making

**Benefits:**
- **Player experience:** Rich narrative reports explaining what happened and why
- **AI behavior:** More responsive, opportunistic, realistic reactions
- **Developer analysis:** Detailed event logs for balance tuning
- **Debugging:** Event-driven replay system for bug reproduction

**Guiding Principles (from GameEvents_Guide.md):**

1. **Events represent things that happened** (temporal occurrences)
2. **Hybrid reports:** Combine state (current situation) + events (narrative)
3. **Fog of war filtering:** AI only receives observable events
4. **Proper granularity:** Observable outcomes, not internal calculations
5. **Three audiences:** AI (filtered), Player (narrative), Developer (analysis)

**Current Espionage Implementation as Template:**

The espionage events we just implemented (2025-12-11) serve as the template for other systems:
```nim
// Event factory pattern
proc scoutColonyIntelGathered*(
  spyHouse: HouseId, targetHouse: HouseId, systemId: SystemId,
  fleetId: FleetId, defenses: int, economicValue: int,
  hasStarbase: bool, quality: string
): GameEvent =
  // Capture rich details for narrative
  var details = &"Defenses: {defenses}, Economy: {economicValue} PP"
  // Return event with description + structured data
```

**References:**
- **Guide:** `docs/guides/GameEvents_Guide.md` (comprehensive pattern documentation)
- **Current implementation:** `src/engine/resolution/event_factory/intelligence.nim`
- **Event processing:** `src/engine/resolution/simultaneous_espionage.nim::processScoutIntelligence`
- **Template to replicate:** Scout intelligence events → apply to combat, fleet ops, etc.

---

**Maintained by:** AI Development Team
**Related Documentation:**
- [GOAP Architecture](goap-architecture-old.md) - Full GOAP implementation details (Archived)
- [RBA Decision Hierarchy](rba-decision-hierarchy-old.md) - RBA advisor structure (Archived)
- [Unit Progression](../mechanics/unit-progression.md) - Game balance mechanics
