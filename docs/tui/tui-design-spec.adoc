= EC4X TUI Design Spec
:status: Draft
:scope: Design only (no runtime config)

== Purpose
Define the EC4X text UI layout, navigation, and visual language for
implementation in `src/player/`. This is a design spec only. It does not
introduce runtime configuration or a layout engine.

== Goals
* Preserve the classic EC atmosphere while improving usability.
* Keep always-on empire context visible across views.
* Support fast keyboard navigation with clear hotkey hints.
* Maintain consistent, reusable UI patterns.

== Non-Goals
* Hot reload or runtime layout configuration.
* Fully declarative widget trees.
* Reusable UI framework for other games.

== Viewport Targets
* Minimum supported width: 120 columns
* Target height: 32+ rows

Responsive rules:
* If width < 120, block UI and show a terminal-too-narrow message.
* Suggested message: `Terminal too narrow (need 120 cols, have NN).`

Example (narrow terminal):
----
┌────────────────────────────────────────────────────────────────────────┐
│                                                                        │
│        Terminal too narrow (need 120 cols, have 96).                   │
│                                                                        │
│        Resize your terminal to continue.                               │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
----

== Screen Regions
----
+------------------------------------------------------------------------------+
| HUD STRIP (2 lines)                                                          |
|   Left: Empire + Turn    Center: Prestige/Treasury/Prod/C2    Right: Alerts  |
+------------------------------------------------------------------------------+
| BREADCRUMB LINE (1 line)                                                     |
|   Home > Fleets > Alpha Patrol                                               |
+------------------------------------------------------------------------------+
|                                                                              |
| MAIN CANVAS (variable height)                                                |
|   - All windows in the main canvas are modal overlays                        |
|   - Centered floating modals for 9 primary views                             |
|   - Single-line borders (--) for modals and overlays                         |
|                                                                              |
+------------------------------------------------------------------------------+
| STATUS BAR (1 line)                                                          |
|   Ctrl+ [O] OVR  [Y] CLN  [F] FLT ... [:] EXPERT  :command input_             |
+------------------------------------------------------------------------------+
----

== Shared Systems

=== Shared Table Layout Policy
All table views in Player TUI follow one sizing and scrolling contract.

Sizing rules:
* Max visible rows per table: 20 (`DefaultTableRowCap`)
* Max table height budget: 75% of viewport height
* Minimum visible rows: 1
* Table chrome overhead: 4 rows (top border, header, separator, bottom border)
* Modal footer overhead: 2 rows (separator + footer hint row)
* Panel frame overhead: 2 rows

Behavior rules:
* Visible row count is clamped by content size, row cap, and viewport budget.
* When content exceeds visible rows, vertical scrolling is required.
* Scroll offsets must be clamped against content length and viewport length.
* Multi-pane table layouts (for example Fleet Command Systems/Fleets) use the
  same computed visible-row budget so both panes render at equal vertical size.
* Table sizing logic must use shared helpers in
  `src/player/tui/table_layout_policy.nim` rather than ad-hoc formulas.

=== Intel Freshness (LTU)
LTU tracks intel freshness for the player view (fog-of-war), not authoritative
game state.

LTU storage in PlayerState:
* ltuSystems: Table[SystemId, int32]
* ltuColonies: Table[ColonyId, int32]
* ltuFleets: Table[FleetId, int32]
* No ship-level LTU

LTU rules:
* Owned assets: LTU = current turn.
* Uncolonized systems: use ltuSystems[systemId] or "—".
* Colonized systems: use ltuColonies[colonyId] if present, else fall back to
  ltuSystems[systemId].

== Primary Views (Global Ctrl+Key)
* `Ctrl+O` Overview     (Info Dashboard)
* `Ctrl+P` Reports      (Turn Reports / Event Inbox)
* `Ctrl+G` General      (Diplomacy & Empire Policy)
* `Ctrl+Y` Colony       (Colony Management)
* `Ctrl+F` Fleet        (Fleet Operations)
* `Ctrl+T` Tech         (Research & Development)
* `Ctrl+E` Espionage    (Intel Operations & Budget)
* `Ctrl+I` Intel db     (Starmap Database)
* `Ctrl+K` Settings     (Client Configuration)
* `Ctrl+X` Quit

=== Overview (`O`)
Dashboard summary of the current turn state.
* **Vital Signs**: Treasury (PP), Prestige, Current Turn.
* **Aggregates**: Total Population (PU), Total Colony Count, Total Ships.
* **Standing**: Current Rank (from Leaderboard).
* **Alerts**: Critical warnings (Invasions, Shortfalls).

=== Reports (`R`)
Comprehensive inbox of all `GameEvent`s generated during the turn resolution.
* Categories: Combat, Economy, Diplomacy, Espionage, Tech, General.
* Functionality: Filter by category, Mark Read, Delete.
* Detail view for complex events (Combat Reports).

=== General (`G`)
Empire-wide management and foreign policy.
* **Diplomacy**:
  - View diplomatic status (Neutral/Hostile/Enemy) with other Houses.
  - Issue `DiplomaticCommand`: Declare War, Propose Peace, Accept/Reject Treaties.
* **Empire Policy**:
  - Global Tax Rate: Slider that generates `ColonyManagementCommand` updates for all colonies.
  - Policy Defaults: Global toggles for Auto-Repair, Auto-Load (applied to all colonies).

=== Colony View (`C`)
Management of owned and administered colonies.
Intent: a single full-width modal table in the Main Canvas.
Note: LTU is not shown here as owned colonies always have perfect, real-time intel.

Ordering:
* Homeworld pinned to the top.
* Remaining owned systems alphabetical by system name.

Columns (120 cols target):
* System (name)
* Sec (system coords)
* Cls (planet class)
* Res (resource rating)
* Pop (PU)
* IU
* GCO
* NCV
* Δ (population growth)
* CD (construction dock capacity)
* RD (repair dock capacity)
* Flt (fleets in system)
* SB (starbases)
* A+M (ground units: armies + marines)
* GB (ground batteries)
* Sld (planetary shield: Y/N)
* Status (comma-separated flags)

Column budget (120 cols target):
* System: 14
* Sec: 4
* Cls: 3
* Res: 3
* Pop: 4
* IU: 4
* GCO: 5
* NCV: 5
* Δ: 5
* CD: 2
* RD: 2
* Flt: 2
* SB: 2
* A+M: 2
* GB: 2
* Sld: 3
* Status: 0 (auto-width, minWidth 4, expands to fill remaining width)

Column alignment spec:
----
System: width=14  align=left   truncate=ellipsis
Sec:    width=4   align=center truncate=none
Cls:    width=3   align=center truncate=none
Res:    width=3   align=center truncate=none
Pop:    width=4   align=center truncate=none
IU:     width=4   align=center truncate=none
GCO:    width=5   align=center truncate=none
NCV:    width=5   align=center truncate=none
Δ:      width=5   align=center truncate=none
CD:     width=2   align=center truncate=none
RD:     width=2   align=center truncate=none
Flt:    width=2   align=center truncate=none
SB:     width=2   align=center truncate=none
A+M:    width=2   align=center truncate=none
GB:     width=2   align=center truncate=none
Sld:    width=3   align=center truncate=none
Status: width=0   align=center truncate=ellipsis (auto, minWidth=4)
----

Table sketch (borderless zebra-striped):
----
SYSTEM          Sec  Cls Res Pop  IU   GCO   NCV    Δ   CD RD Flt SB A+M GB Sld Status
─────────────────────────────────────────────────────────────────────────────────────────
Caladan         A01  BEN RIC 120  80   400   220  +1.2 10  8  2  1  20  5   Y  OK
Arrakis         C03  HRH ABD  60  40   180    96  +0.6  6  4  5  0   0  2   N  CN, TF
Ix              B09  LSH RIC  90  70   320   180  +0.9  8  6  0  1   5  2   Y  ⚠ BLK, CAP, DMG
----

NOTE: The actual rendering uses `showBorders(false)` and `zebraStripe(true)`, producing
a compact list view without box characters. Alternate rows receive subtle background tinting
for readability.

Status legend (prioritized):
* BLK: Blockaded (Critical)
* CAP: Capacity Violation (Hangar/Garrison)
* DMG: Infrastructure/Facility Damage
* RPR: Repairing
* TF:  Terraforming active
* CN:  Construction active
* OK:  Nominal

==== Colony Modal Variant

For detail/modal views, a bordered table variant (`buildPlanetsTable`) is available with
slightly different styling:

* Uses `showBorders(true)` for full box drawing
* Right-aligns numeric columns (Pop, IU, GCO, NCV, Δ, CD, RD, Flt, SB, Gnd, Bat) instead of center
* Status column: width=4, left-aligned (fixed width instead of auto)
* Column headers use "Grw" instead of "Δ", "Gnd" instead of "A+M", "Bat" instead of "GB", "Shd" instead of "Sld"

This variant is used when presenting colony data in a focused modal context where the
bordered presentation provides better visual separation from surrounding UI elements.

Example (bordered modal):
----
┌────────────────────────────────────────────────────────────────────────────────────────┐
│SYSTEM          Sec  Cls Res  Pop   IU   GCO   NCV   Grw CD RD Flt SB Gnd Bat Shd Status│
├────────────────────────────────────────────────────────────────────────────────────────┤
│Caladan         A01  BEN RIC  120   80   400   220  +1.2 10  8  2  1  20  5   Y  OK     │
│Arrakis         C03  HRH ABD   60   40   180    96  +0.6  6  4  5  0   0  2   N  CN     │
└────────────────────────────────────────────────────────────────────────────────────────┘
----

* **Commands**:
  - `BuildCommand`: Ships, Facilities, Ground Units.
  - `ScrapCommand`: Recycling assets.
  - `RepairCommand`: Manual repairs.
  - `TerraformCommand`: Planetary engineering.
  - `PopulationTransferCommand`: Migration.
  - `ColonyManagementCommand`: Tax rates, auto-repair toggles (per-colony override).

=== Fleet View (`F`)
Command and Control for fleets.
* **Table View**: Lists fleets with location, composition, and orders.
* **Detail View**: Ship-level status and cargo.
* **Commands**:
  - `[C]` Command: 20 operational commands (00-19) - Move, Patrol, Hold, Guard, Attack, etc.
  - `[R]` ROE: Rules of Engagement (0-10 scale)
  - `[Z]` Zero-Turn: 9 administrative commands (instant, no turn cost) - DetachShips, TransferShips, MergeFleets, LoadCargo, UnloadCargo, LoadFighters, UnloadFighters, TransferFighters, Reactivate

==== Fleet Label System

Fleets use an internal `FleetId` (uint32, global, monotonic) for engine state, but the
player-visible identifier is a 2-character per-house label.

**Label format:** Letter + alphanumeric (A1, A2, ..., A9, AA, AB, ..., AZ, B1, ..., ZZ).
This gives 910 labels per house (26 first chars x 35 second chars).

**Assignment rules:**

* Labels are per-house — each house has an independent namespace.
* New fleets receive the lowest available label by scanning existing names.
* When a fleet is destroyed, its label returns to the pool and may be reused.
* Labels are stable for the lifetime of a fleet (never reassigned while fleet exists).

==== Fleet List View (ListView)

ListView is a full-width bordered table for empire-wide fleet management.
SystemView remains the 2-pane location-focused console.

* Toggle views: `L`
* Sorting: Left/Right arrow keys select column, `S` toggles ascending/descending
* Label-jump: Type 2-character fleet label (e.g. A1, B3) to jump to that fleet
* Batch: `X` to select fleets, `C` for batch command, `R` for batch ROE, `Z` for batch zero-turn
  - If no `[X]` selection exists: `[C]`/`[R]`/`[Z]` act on cursor-row fleet (implicit selection)
  - If `[X]` selection exists: `[C]`/`[R]`/`[Z]` act on ALL selected fleets

**ListView Layout:**
----
┌─ EC4X Fleet View ─ Turn 12 ─ House Atreides ─────────────────────────────────┐
│┌─────────────────────────────────────────────────────────────────────────────┐│
││FLT LOCATION       SECT  SHIPS AS  DS  CMD     DEST       ETA ROE STATUS    ││
││──────────────────────────────────────────────────────────────────────────────││
││A1  Arrakis        C03      12 100 300 HOLD    -            0   7 Ready     ││
││A2  Caladan        A01       8  34 123 MOVE    D12          3   6 Transit   ││
││A3  Arrakis        C03       4 124  34 GUARD   C03          0   5 Guard     ││
││A4  Giedi Prime    HUB       3  69  69 BOMBARD B09          4   8 Attack    ││
││A5  Ix             B09       6  45  78 PATROL  B09-C03      2   6 Transit   ││
││A6  Caladan        A01      15 234 456 RESERVE -            0   4 Reserved  ││
│└─────────────────────────────────────────────────────────────────────────────┘│
│                                                                               │
│ [↑↓]Nav [Enter]Details [X]Select [←→]Sort [S]Asc/Desc [C]Cmd [R]ROE [Z]ZTC  │
└───────────────────────────────────────────────────────────────────────────────┘
----

**Columns** (widths from code):
* Flt 3 (Per-house label with prefix glyphs)
* Location 14
* Sect 5 (sector coordinates)
* Ships 6
* AS 4
* DS 4
* CMD 7
* Dest 10 (destination coordinates)
* ETA 4
* ROE 4
* Status 8

**Footer hints**:
* `[↑↓]Nav [Enter]Details [X]Select [←→]Sort [S]Asc/Desc [C]Cmd [R]ROE [Z]ZTC`

**Status prefixes**:
* `●` staged command pending
* `⚠` needs attention (crippled ships, no orders, or unescorted support)

==== Fleet Command Console (SystemView - Detailed)
Intent: fast, multi-fleet command and per-ship zero-turn management.

**SystemView Layout (2-pane):**
----
┌─ EC4X Fleet Command ─ Turn 12 ─ House Atreides ──────────────────────────────┐
│                                                                              │
│ ┌─ Systems (5) ─────┐  ┌─ Arrakis (3) ────────────────────────────────────┐ │
│ │SYSTEM         SECT│  │FLT SHIPS AS  DS  TT ETAC CMD    TGT   ETA ROE STS│ │
│ │──────────────────│  │───────────────────────────────────────────────────│ │
│ │  Spatharo... D07 │  │A1    12 100 300  4   2 HOLD    -       0   7 RDY│ │
│ │  Caladan     A01 │  │A2     8  34 123  0   0 MOVE    D12      3   6 TRN│ │
│ │  Arrakis     C03 │  │A3     4 124  34  0   0 GUARD   C03      0   5 GRD│ │
│ │  Giedi Prime HUB │  │A4     3  69  69  0   0 BOMBARD B09      4   8 ATK│ │
│ │  Ix          B09 │  │                                                    │ │
│ └──────────────────┘  └───────────────────────────────────────────────────┘ │
│                                                                              │
│ [↑↓←→]Nav [Enter]Details [Tab]Pane [X]Select [C]Cmd [R]ROE [Z]ZeroTurn     │
└──────────────────────────────────────────────────────────────────────────────┘
----

**Fleet Detail Modal (opened with Enter on fleet):**
----
┌─ Fleet Detail ────────────────────────────────────────────────────────────────┐
│ Fleet A1 at Arrakis                                                          │
│ Command: HOLD  ROE: 7                                                        │
│ Ships: 12  AS: 100  DS: 300                                                  │
│                                                                              │
│ SHIPS (12)                                                                   │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │CLASS          STATE     AS   DS  WEP  MAR                                │ │
│ │────────────────────────────────────────────────────────────────────────│ │
│ │  Light Cruiser Nominal  48   32    2    0                               │ │
│ │  Frigate       Crippled 36   24    1    0                               │ │
│ │  Raider        Nominal  12   45    6    0                               │ │
│ │  Troop Transp  Crippled 10   15    1    8                               │ │
│ │  ETAC          Nominal  10   30    1    0                               │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│ [C]Command [R]ROE [PgUp/PgDn]Scroll [Esc]Close                               │
└──────────────────────────────────────────────────────────────────────────────┘
----

Interaction rules:
* `[C]`/`[R]`/`[Z]` act on cursor-row fleet if no `[X]` selection exists.
* `[C]`/`[R]`/`[Z]` act on ALL `[X]`-selected fleets when selection exists.
* `[X]` toggles multi-select in both ListView and SystemView fleet pane.
* Batch mode: same command/ROE/ZTC applied to all selected fleets.

Column widths:
* **SystemView Systems pane**: System 14, Sect 5
* **SystemView Fleets pane**: Flt 3, Ships 5, AS 4, DS 4, TT 3, ETAC 4, CMD 6, TGT 5, ETA 3, ROE 3, STS 3
* **Fleet Detail ship table**: Class 14, State 8, AS 4, DS 4, WEP 4, Mar 4

Key map:
* `C` Command (apply to cursor fleet or selected fleets)
* `R` ROE (apply to cursor fleet or selected fleets)
* `Z` Zero Turn (apply to cursor fleet or selected fleets)
* `X` Toggle multi-select on current row
* `Tab` Switch between Systems and Fleets panes
* `Enter` Open Fleet Detail modal for cursor fleet

==== Fleet Command Menu System

This section documents the unified menu flow for all fleet command operations: operational commands (`[C]`), rules of engagement (`[R]`), and zero-turn commands (`[Z]`).

===== Selection Model

Fleet commands operate on either a single fleet (cursor-implicit) or multiple fleets (explicit multi-select):

[%header,cols="1,2,2"]
|===
| Mode | Condition | Behavior

| Cursor-Implicit
| No `[X]` selection exists
| `[C]`/`[R]`/`[Z]` act on the fleet under the cursor

| Explicit-Multi
| One or more `[X]` selections exist
| `[C]`/`[R]`/`[Z]` act on ALL selected fleets (batch mode)

| Batch Semantics
| Explicit-Multi mode
| Same command, target, or parameter applied to all selected fleets
|===

This design eliminates the need to explicitly select a single fleet - just position the cursor and press `[C]`/`[R]`/`[Z]`. Use `[X]` only when you want to command multiple fleets at once.

**Implementation note:** The cursor-implicit selection is the **design target**. Current code may require explicit `[X]` selection for `[C]` and `[R]` operations (enforced via `hasFleetSelection` guard). The spec documents the intended behavior; code will be updated to match.

===== Menu Flow Diagram

The following diagram shows the complete command flow from key press to staged proposal:

[mermaid]
----
flowchart TD
    Start([User presses C/R/Z]) --> Resolve{Selection Resolution}
    Resolve -->|Cursor-implicit| Single[Single fleet]
    Resolve -->|Explicit-multi| Multi[Multiple fleets]
    Single --> Branch{Key Branch}
    Multi --> Branch

    Branch -->|C| CmdPicker[Command Picker Modal]
    Branch -->|R| ROEPicker[ROE Picker Modal]
    Branch -->|Z| ColonyCheck{Fleet at colony?}

    ColonyCheck -->|No| Warn[Show warning banner]
    ColonyCheck -->|Yes| ZTCPicker[ZTC Picker Modal]

    CmdPicker --> CmdType{Command Type}
    CmdType -->|No params| Stage1[Stage proposal]
    CmdType -->|Target system| OrderEntry[Order Entry Mode]
    CmdType -->|Target fleet| FltPicker1[Fleet Picker]
    CmdType -->|Destructive| Confirm1[Confirm Prompt]

    OrderEntry --> MapView[Exit to hex map]
    MapView --> SelectSys[User clicks system]
    SelectSys --> Stage2[Stage proposal]

    FltPicker1 --> Stage3[Stage proposal]
    Confirm1 -->|Yes| CheckParams{Needs params?}
    Confirm1 -->|No| Return1[Return to fleet view]
    CheckParams -->|Target| OrderEntry
    CheckParams -->|No| Stage4[Stage proposal]

    ROEPicker --> Stage5[Stage proposal]

    ZTCPicker --> ZTCType{ZTC Type}
    ZTCType -->|DetachShips| ShipSel1[Ship Selector]
    ZTCType -->|TransferShips| FltPicker2[Fleet Picker]
    ZTCType -->|MergeFleets| FltPicker3[Fleet Picker]
    ZTCType -->|LoadCargo/Unload| CargoModal[Cargo Params]
    ZTCType -->|LoadFighters/Unload| FighterModal[Fighter Params]
    ZTCType -->|TransferFighters| FighterModal2[Fighter Params]
    ZTCType -->|Reactivate| Stage6[Stage proposal]

    FltPicker2 --> ShipSel2[Ship Selector]
    ShipSel1 --> Stage7[Stage proposal]
    ShipSel2 --> Stage8[Stage proposal]
    FltPicker3 --> Stage9[Stage proposal]
    CargoModal --> Stage10[Stage proposal]
    FighterModal --> Stage11[Stage proposal]
    FighterModal2 --> Stage12[Stage proposal]

    Stage1 --> Done([Return to fleet view])
    Stage2 --> Done
    Stage3 --> Done
    Stage4 --> Done
    Stage5 --> Done
    Stage6 --> Done
    Stage7 --> Done
    Stage8 --> Done
    Stage9 --> Done
    Stage10 --> Done
    Stage11 --> Done
    Stage12 --> Done
    Return1 --> Done
    Return2 --> Done
    Warn --> Done
----

===== FleetSubModal State Machine

The fleet detail modal manages command workflow through these sub-modal states:

[mermaid]
----
stateDiagram-v2
    [*] --> None: Default view

    None --> CommandPicker: Press C
    None --> ROEPicker: Press R
    None --> ZTCPicker: Press Z (colony check)

    CommandPicker --> OrderEntry: Command needs target system
    CommandPicker --> FleetPicker: Command needs target fleet
    CommandPicker --> ConfirmPrompt: Destructive command
    CommandPicker --> Staged: No-param command
    CommandPicker --> None: Esc to cancel

    OrderEntry --> [*]: Exit modal to map

    FleetPicker --> Staged: Fleet selected
    FleetPicker --> CommandPicker: Esc to cancel

    ConfirmPrompt --> Staged: Confirmed
    ConfirmPrompt --> OrderEntry: Confirmed + needs target
    ConfirmPrompt --> CommandPicker: Denied

    ROEPicker --> Staged: ROE selected
    ROEPicker --> None: Esc to cancel

    ZTCPicker --> ShipSelector: DetachShips
    ZTCPicker --> FleetPicker: TransferShips/MergeFleets
    ZTCPicker --> CargoParams: LoadCargo/UnloadCargo
    ZTCPicker --> FighterParams: LoadFighters/UnloadFighters/TransferFighters
    ZTCPicker --> Staged: Reactivate
    ZTCPicker --> None: Esc to cancel

    ShipSelector --> Staged: Confirm selection
    ShipSelector --> ZTCPicker: Esc to cancel

    FleetPicker --> ShipSelector: For TransferShips

    CargoParams --> Staged: Confirm params
    CargoParams --> ZTCPicker: Esc to cancel

    FighterParams --> Staged: Confirm params
    FighterParams --> ZTCPicker: Esc to cancel

    Staged --> None: Proposal staged, return
----

===== [C] Command Picker

The Command Picker presents all 20 operational commands with their requirements and allows two-digit quick entry.

Wireframe (actual commands from code):
----
┌─ Fleet Command ──────────────────────────────────────────────────────┐
│ CODE  COMMAND              REQUIREMENTS                               │
│ ────  ───────────────────  ───────────────────────────────────────── │
│ 00    Hold                 None                                       │
│ 01    Move                 None                                       │
│ 02    Seek Home            None                                       │
│ 03    Patrol               None                                       │
│ 04    Guard Starbase       Combat ship(s)                             │
│ 05    Guard Colony         Combat ship(s)                             │
│ 06    Blockade             Combat ship(s)                             │
│ 07    Bombard              Combat ship(s)                             │
│ 08    Invade               Combat ship(s) & loaded Transports         │
│ 09    Blitz                Loaded Troop Transports                    │
│ 10    Colonize             One ETAC                                   │
│ 11    Scout Colony         Scout-only fleet (1+ scouts)               │
│ 12    Scout System         Scout-only fleet (1+ scouts)               │
│ 13    Hack Starbase        Scout-only fleet (1+ scouts)               │
│ 14    Join Fleet           None                                       │
│ 15    Rendezvous           None                                       │
│ 16    Salvage              Friendly colony system                     │
│ 17    Reserve              At friendly colony                         │
│ 18    Mothball             At friendly colony w/ Spaceport            │
│ 19    View                 Any ship type                              │
│                                                                       │
│ [↑↓]Select [00-19]Quick [Enter]Confirm [Esc]Cancel                    │
└───────────────────────────────────────────────────────────────────────┘
----

**Two-digit quick entry:**
- Type first digit: modal displays "1_" in status line, starts 300ms timer
- Type second digit within 300ms: command immediately selects and proceeds
- Timer expires: first digit interpreted as "0X" (e.g., "1" → "01")

**Command parameter categories:**

[%header,cols="1,2,2"]
|===
| Category | Commands | Flow After Selection

| No parameters
| 00 Hold, 02 Seek Home, 03 Patrol, 04 Guard Starbase, 05 Guard Colony
| Immediately stage proposal

| Target system
| 01 Move, 06-09 (Blockade/Bombard/Invade/Blitz), 10 Colonize, 11-13 (Scout/Hack), 15 Rendezvous, 19 View
| Enter Order Entry Mode (exit modal to hex map)

| Target fleet
| 14 Join Fleet
| Show FleetPicker sub-modal

| Destructive
| 07 Bombard, 16 Salvage, 17 Reserve, 18 Mothball
| Show ConfirmPrompt, then stage or request target
|===

===== Per-Command Target Filtering Rules

Based on what the engine's dispatcher
(`src/engine/systems/fleet/dispatcher.nim`) validates at execution
time, the SystemPicker is pre-filtered to only show valid targets
for the selected command. If the filtered list is empty, a notice
is shown instead of opening the picker.

[%header,cols="1,2,4,4"]
|===
| Cmd | Name | Target Filter | Empty-list Error

| 01 | Move | Any system | (always has targets)
| 03 | Patrol | Any system | (always has targets)
| 04 | Guard Starbase | Owned colony with starbase (`planetsRows`: `isOwned` +
  `starbaseCount > 0`) | "No friendly starbases found"
| 05 | Guard Colony | Owned colony (`planetsRows`: `isOwned`) |
  "No friendly colonies found"
| 06 | Blockade | Enemy colony (non-owned, non-eliminated) |
  "No known enemy colonies to blockade"
| 07 | Bombard | Enemy colony (non-owned, non-eliminated) |
  "No known enemy colonies to bombard"
| 08 | Invade | Enemy colony (non-owned, non-eliminated) |
  "No known enemy colonies to invade"
| 09 | Blitz | Enemy colony (non-owned, non-eliminated) |
  "No known enemy colonies to blitz"
| 10 | Colonize | Any system (engine handles uncolonized check) |
  (always has targets)
| 11 | Scout Colony | Any system (fails only if target house eliminated) |
  (always has targets)
| 12 | Scout System | Any system (fails only if target house eliminated) |
  (always has targets)
| 13 | Hack Starbase | System with known rival starbase (`intelRows`:
  `starbaseCount.isSome` + `> 0`) |
  "No known enemy starbases to hack"
| 15 | Rendezvous | Any system | (always has targets)
| 16 | Salvage | Owned colony with spaceport or shipyard |
  "No friendly colonies with salvage facilities"
| 17 | Reserve | Owned colony (`planetsRows`: `isOwned`) |
  "No friendly colonies found"
| 18 | Mothball | Owned colony (`planetsRows`: `isOwned`) |
  "No friendly colonies found"
| 19 | View | Any system | (always has targets)
|===

===== Order Entry Mode

After selecting a command that requires a target system (Move, Patrol, Attack, Scout, etc.), the fleet modal closes and the main view switches to the hex map in **Order Entry Mode**.

**Map interaction:**
- Cursor moves freely across hex grid
- Click/Enter on a system: set as target, stage proposal(s), return to fleet view
- Esc: cancel order entry, return to fleet view without staging

**Status bar during Order Entry Mode:**
----
Order Entry: Move → Select target system [Esc] Cancel
----

**Batch behavior:**
- In explicit-multi mode, the SAME target system is applied to all selected fleets
- Example: Select fleets A1, A2, A3 → Press `[C]` → Choose "00 Move" → Click system B07 → All three fleets receive Move commands to B07

===== Confirmation Prompt

Destructive commands require explicit confirmation to prevent accidental fleet loss.

Wireframe (72 columns):
----
┌─ Confirm Destructive Command ────────────────────────────────────────┐
│                                                                       │
│  You are about to BOMBARD the colony at Arrakis with fleet A4.       │
│                                                                       │
│  This will cause civilian casualties and damage infrastructure.       │
│                                                                       │
│  Are you sure you want to proceed?                                    │
│                                                                       │
│            [Y] Yes, proceed      [N] No, cancel                       │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
----

**Commands requiring confirmation:**
- 07 Bombard (civilian casualties)
- 16 Salvage (fleet disbanded)
- 17 Reserve (ships deactivated)
- 18 Mothball (ships deactivated, maintenance cost)

**Flow after confirmation:**
- If command requires additional parameters (target system): proceed to Order Entry Mode
- If no additional parameters: immediately stage proposal
- If denied: return to Command Picker

===== FleetPicker Sub-Modal

Used for commands that target another fleet: Join Fleet (operational), Transfer Ships, Merge Fleets (ZTCs).

Wireframe (72 columns):
----
┌─ Select Target Fleet ────────────────────────────────────────────────┐
│ FLT  LOCATION           SHIPS  AS   DS   STATUS                      │
│ ───  ─────────────────  ─────  ───  ───  ─────────────────────────── │
│ A1   Arrakis            12     240  180  HOLD                        │
│ A2   Arrakis            8      120  90   PATROL (B07)                │
│ A3   Arrakis            3      45   30   GUARD COLONY                │
│                                                                       │
│ [↑↓]Select [Enter]Confirm [Esc]Cancel                                 │
└───────────────────────────────────────────────────────────────────────┘
----

**Eligibility criteria:**
- Same house (owned by player)
- Same system as source fleet
- Active status (not Reserved, Mothballed, or in transit)

**Greying/hiding:**
- Ineligible fleets shown in muted text or hidden entirely
- If no eligible fleets exist: show "No eligible fleets in this system" message

===== [R] ROE Picker

The ROE Picker sets Rules of Engagement for selected fleet(s) on a 0-10 scale.

Wireframe (actual ROE values from code):
----
┌─ Rules of Engagement ────────────────────────────────────────────────┐
│ ROE  LABEL        DESCRIPTION                                         │
│ ───  ───────────  ──────────────────────────────────────────────────  │
│  0   Avoid        Avoid all hostile forces                            │
│  1   Flee         Engage only defenseless targets                     │
│  2   Flee         Need 4:1 advantage to engage                        │
│  3   Cautious     Need 3:1 advantage to engage                        │
│  4   Cautious     Need 2:1 advantage to engage                        │
│  5   Defensive    Need 3:2 advantage to engage                        │
│  6   Standard     Fight if equal or superior                          │
│  7   Aggressive   Fight even at 2:3 disadvantage                      │
│  8   Aggressive   Fight even at 1:2 disadvantage                      │
│  9   Desperate    Fight even at 1:3 disadvantage                      │
│  10  Suicidal     Fight regardless of odds                            │
│                                                                       │
│ [↑↓]Select [Enter]Confirm [Esc]Cancel                                 │
└───────────────────────────────────────────────────────────────────────┘
----

**Direct digit entry:**
- Single digit (0-9): immediately sets ROE and stages proposal
- Two digits (10): type "1" then "0" within 300ms to select ROE 10

**Batch behavior:**
- In explicit-multi mode, the SAME ROE value is applied to all selected fleets

===== [Z] Zero-Turn Command Menu

Zero-turn commands (ZTCs) are administrative actions that execute instantly without consuming a fleet's turn. They require the fleet to be at a colony.

**Colony requirement check:**
- If selected fleet(s) are NOT at a colony: show banner "Zero-turn commands require fleet to be at a colony" and return
- If at colony: proceed to ZTC Picker

Wireframe (actual ZTCs from code):
----
┌─ Zero-Turn Commands ─────────────────────────────────────────────────┐
│ #  COMMAND              DESCRIPTION                                   │
│ ─  ───────────────────  ──────────────────────────────────────────── │
│ 1  Detach Ships         Split ships from fleet into new fleet        │
│ 2  Transfer Ships       Move ships to another fleet (same system)    │
│ 3  Merge Fleets         Dissolve this fleet into another             │
│ 4  Load Cargo           Load marines/colonists onto transport ships  │
│ 5  Unload Cargo         Unload cargo from transport ships            │
│ 6  Load Fighters        Load fighter ships from colony to carrier    │
│ 7  Unload Fighters      Unload fighter ships from carrier to colony  │
│ 8  Transfer Fighters    Transfer fighter ships between carriers      │
│ 9  Reactivate           Return Reserved/Mothballed fleet to active   │
│                                                                       │
│ Type 1-9 or [Esc] to cancel                                           │
└───────────────────────────────────────────────────────────────────────┘
----

**Single-digit quick select:**
- Type 1-9: immediately proceed to next step for that ZTC

**Eligibility greying:**
- Commands that cannot be executed (e.g., Reactivate when no ships are mothballed) shown in muted text
- Hovering over greyed command shows reason: "No reserved or mothballed ships in fleet"

**Batch mode limitations:**
- Ship-level ZTCs (Detach, Transfer): batch mode disabled, act on cursor fleet only
- Fleet-level ZTCs (Merge, Cargo, Fighters): batch mode allowed
- Rationale: Ship selection is fleet-specific and cannot be meaningfully batched

===== ZTC Sub-Modals

====== ShipSelector (for Detach/Transfer)

Checkbox list allowing selection of individual ships to detach or transfer.

**Note:** Modal title changes based on context:
- "Select Ships to Detach" for DetachShips ZTC
- "Select Ships to Transfer" for TransferShips ZTC

Wireframe (72 columns):
----
┌─ Select Ships to Detach ─────────────────────────────────────────────┐
│ [ ] Battleship Indomitable       WEP 08  AS 120  DS 80               │
│ [X] Cruiser Valiant              WEP 04  AS 60   DS 40               │
│ [X] Frigate Swift                WEP 02  AS 30   DS 20               │
│ [ ] Troop Transport Hercules     WEP 01  AS 10   DS 15               │
│ [X] ETAC Oracle                  WEP 01  AS 10   DS 30               │
│                                                                       │
│ Selected: 3 ships  (100 AS / 90 DS)                                   │
│                                                                       │
│ [X] Toggle  [A]ll  [N]one  [Enter] Confirm  [Esc] Cancel              │
└───────────────────────────────────────────────────────────────────────┘
----

**Interactions:**
- `[X]`: Toggle checkbox on cursor row
- `[A]`: Select all ships
- `[N]`: Deselect all ships
- `[Enter]`: Confirm selection, stage proposal
- `[Esc]`: Cancel, return to ZTC Picker

**Validation:**
- Cannot select zero ships
- For Detach: cannot select all ships (must leave at least one in original fleet)
- For Transfer: must have a valid target fleet selected first

====== CargoParams (for Load/Unload Cargo)

Simple parameter collection for cargo operations.

Wireframe (72 columns):
----
┌─ Load Cargo ─────────────────────────────────────────────────────────┐
│                                                                       │
│  Cargo Type:  [Colonists ▼]                                           │
│               ─────────────                                           │
│               Colonists                                               │
│               Troops (MD)                                             │
│               Supplies (SU)                                           │
│                                                                       │
│  Quantity:    [______] (max: 120 available, 50 cargo capacity)        │
│                                                                       │
│                                                                       │
│  [Enter] Confirm  [Esc] Cancel                                        │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
----

**Validation:**
- Quantity must be > 0
- For Load: quantity ≤ min(colony stores, fleet cargo capacity remaining)
- For Unload: quantity ≤ current cargo loaded

====== FighterParams (for Load/Unload/Transfer Fighters)

**Context variants:**
- **LoadFighters**: Load fighters from colony to carrier
- **UnloadFighters**: Unload fighters from carrier to colony
- **TransferFighters**: Transfer fighters between two carriers (requires source and target carrier selection)

Wireframe for Load/Unload (72 columns):
----
┌─ Load Fighters ──────────────────────────────────────────────────────┐
│                                                                       │
│  Fleet carrier capacity: 48                                           │
│  Currently loaded:       24                                           │
│  Available in hangars:   60                                           │
│                                                                       │
│  Quantity to load:  [______] (max: 24)                                │
│                                                                       │
│                                                                       │
│  [Enter] Confirm  [Esc] Cancel                                        │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
----

Wireframe for TransferFighters (72 columns):
----
┌─ Transfer Fighters ──────────────────────────────────────────────────┐
│                                                                       │
│  Source carrier:    [Carrier Alpha ▼]                                 │
│  Target carrier:    [Carrier Beta ▼]                                  │
│                                                                       │
│  Source capacity: 48  Loaded: 36  Available to transfer: 36           │
│  Target capacity: 48  Loaded: 12  Available capacity: 36              │
│                                                                       │
│  Quantity to transfer:  [______] (max: 36)                            │
│                                                                       │
│                                                                       │
│  [Enter] Confirm  [Esc] Cancel                                        │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
----

**Validation:**
- Quantity must be > 0
- For Load: quantity ≤ min(colony hangar stock, carrier capacity remaining)
- For Unload: quantity ≤ currently loaded fighters
- For TransferFighters: quantity ≤ min(source carrier loaded, target carrier capacity remaining)

===== Key Bindings Table

Complete reference of all fleet command interactions:

[%header,cols="1,2,3,2"]
|===
| Key | Context | Action | Condition

| `C`
| Fleet view (any)
| Open Command Picker
| Cursor on fleet OR fleet(s) selected

| `R`
| Fleet view (any)
| Open ROE Picker
| Cursor on fleet OR fleet(s) selected

| `Z`
| Fleet view (any)
| Open ZTC Picker
| Fleet(s) at colony

| `X`
| ListView / SystemView fleet pane
| Toggle multi-select on cursor row
| Any fleet

| `0-9`
| Command Picker
| Quick-select command (two-digit)
| Modal open

| `0-9`
| ROE Picker
| Quick-select ROE level
| Modal open

| `1-9`
| ZTC Picker
| Quick-select ZTC
| Modal open

| `Enter`
| Any picker modal
| Confirm selection
| Valid selection

| `Esc`
| Any sub-modal
| Cancel and return to parent
| Always

| `Click`
| Order Entry Mode (hex map)
| Select target system
| Map view active

| `Y/N`
| Confirmation Prompt
| Confirm/Deny destructive action
| Prompt visible

| `↑/↓`
| Any picker modal
| Navigate list
| List has focus

| `X`
| ShipSelector
| Toggle ship selection
| Ship list

| `A`
| ShipSelector
| Select all ships
| Ship list

| `N`
| ShipSelector
| Deselect all ships
| Ship list
|===

=== Tech View (`T`)
Research and Development management.
* **Allocation**: Slider/Input for `ResearchAllocation` (Economic vs Science vs Tech Fields).
* **Tree Status**: View current levels and progress towards next level.
* **Breakthroughs**: View recent tech breakthroughs.

=== Espionage View (`E`)
Intelligence and Counter-Intelligence operations.
* **Budget**: Set `ebpInvestment` (Offensive) and `cipInvestment` (Defensive).
* **Operations**: Issue `EspionageAttempt` orders (Spy, Sabotage, Steal Tech).
* **Network**: View infiltration status on target Houses.

=== Intel db (`I`)
Read-only database of the known galaxy. Complements the SVG Starmap.

Note on LTU: This view HEAVILY relies on `PlayerState.ltuSystems` and `ltuColonies`.
Data shown here reflects the *last known state* of a system, not the current engine state.
Users should check the LTU column to judge the staleness of the intelligence.

* **Scope**: All known systems (Owned, Enemy, Neutral, Unexplored).
* **Data**: Planet Class, Resource Rating, Star Type, Coordinates.
* **Function**: Reference for planning colonization or conquest.
* **LTU Display**: All rows must clearly show the turn of the last update.

Columns (Draft):
* System (Name)
* Sector (Coords)
* Known Owner (Last seen owner)
* Intel (Scan/Vis/Full)
* LTU (Turn number of last update)
* Notes (Artifacts, anomalies, etc.)

=== Settings (`S`)
Client-side configuration.
* TUI Theme/Colors.
* Keybindings.
* Notification preferences.

== Visual Language

=== Theme Strategy
The TUI uses a semantic theme system rather than hardcoded colors.
Target Aesthetic: **Tokyo Night** (Deep charcoal backgrounds, slate borders, high-contrast accents).

|===
| Semantic Role | Default "Tokyo Night" | Usage
| `Surface.Main`      | #1a1b26 (Charcoal) | Main window backgrounds
| `Surface.Panel`     | #24283b (Deep Blue)| Sidebars, headers
| `Surface.Overlay`   | #2f334d (Slate)    | Modals, dropdowns
| `Border.Primary`    | #565f89 (Blue-Grey)| Active window borders
| `Border.Dim`        | #414868 (Dark Grey)| Inactive borders
| `Text.Primary`      | #c0caf5 (White-ish)| Standard text
| `Text.Muted`        | #565f89 (Grey)     | Labels, hints
| `State.Info`        | #7aa2f7 (Blue)     | Info, selection
| `State.Success`     | #9ece6a (Green)    | Growth, positive delta, safe
| `State.Warning`     | #e0af68 (Orange)   | Warnings, low supplies
| `State.Error`       | #f7768e (Red)      | Alerts, damage, enemies
| `State.Accent`      | #bb9af7 (Purple)   | Prestige, key focus items
|===

=== Borders and Typography
* Primary panels: double-line `═║╔╗╚╝╠╣╦╩╬`
* Dialogs/overlays: single-line `─│┌┐└┘├┤┬┴┼`
* Subtle grouping: dotted `···` or light box `╌`
* Headings: ALL CAPS, left-aligned
* Monospace alignment: 2-space gutters, 80-char line limit in content

=== Glyphs
|===
| Glyph | Meaning
| `★` | Prestige
| `●` | OK / Neutral diplomatic status
| `⚠` | Needs Attention / Hostile status
| `⚔` | Enemy diplomatic status
| `☠` | Eliminated
| `RSV` | Reserve status
| `MTB` | Mothballed status
| `▲▼` | Trend up/down
| `✉` | Unread message/report
| `▓░` | Progress bar
|===

== Input Model

=== Navigation
----
[Ctrl + Key]      Switch primary views (e.g., Ctrl+F for Fleets)
[Tab/S-Tab]       Cycle focusable widgets within view
[Enter]           Drill into selected item / confirm action
[Esc]             Step up breadcrumb / Cancel overlay / Exit mode
[?]               Show context help overlay
----

=== Context Commands
Within views, single-letter hotkeys trigger actions on the *selected item*:

|===
| Key | Context | Action
| `c` | Fleet selected | Command picker overlay
| `r` | Fleet selected | ROE picker overlay
| `z` | Fleet selected | Zero-turn command picker overlay
| `x` | Fleet/Multi-select | Toggle selection on current row
| `b` | Colony selected | Build (construction queue)
| `t` | Colony selected | Adjust tax rate
| `l` | General | Diplomatic matrix overlay
| `d` | Reports | Delete selected report
| `a` | Proposals | Accept proposal
| `r` | Proposals | Reject proposal
|===

=== Kitty Keyboard Protocol (KKP)

The TUI enables **Kitty Keyboard Protocol level 1** at startup and disables it
on exit. This is the standard for all terminal input in this codebase.

==== Motivation

Legacy terminals multiplex several distinct key presses onto the same byte
sequences, making them ambiguous at the application level:

* `Ctrl+I` and `Tab` both produce `0x09`
* `Ctrl+M` and `Enter` both produce `0x0D`
* A bare `ESC` and the start of any escape sequence both produce `0x1B`

KKP disambiguates these by having the terminal send unique CSI-u sequences
for every key press.

==== Protocol details

[%header,cols="2,2,3"]
|===
| Operation | Sequence | When
| Enable level 1 | `\x1b[>1u` | After entering alternate screen
| Pop / disable | `\x1b[<u`  | Before exiting alternate screen
|===

Level 1 is the minimum level. It reports only the keys that were ambiguous
under legacy encoding. Arrow keys and function keys continue to use the
traditional xterm CSI format (`ESC [ A`, `ESC [ 11~`, etc.) unless a higher
level is requested (it is not, currently).

==== CSI-u format

KKP key events arrive as:

----
ESC [ <codepoint> ; <modifier> u
----

where `<modifier>` uses 1-based CSI modifier encoding:
`1`=none, `2`=shift, `3`=alt, `4`=shift+alt, `5`=ctrl, `6`=shift+ctrl,
`7`=alt+ctrl, `8`=shift+alt+ctrl.

==== Special codepoints handled in `parseCSIu`

[%header,cols="1,2,2"]
|===
| Codepoint | Key | Notes
| 9   | `Key.Tab`       | Also `CSI 9;5u` → `Key.CtrlI` via `ctrlKeyFromRune`
| 13  | `Key.Enter`     |
| 27  | `Key.Escape`    | Bare ESC press — not the start of an escape sequence
| 127 | `Key.Backspace` |
| 65–90 / 97–122 + Ctrl mod | Dedicated `Key.Ctrl*` | Via `ctrlKeyFromRune`
|===

==== Arrow keys under KKP

KKP level 1 may send arrow keys as `CSI 1;<modifier>A/B/C/D` instead of the
bare `ESC [ A`. The parser handles this in `parseCSI`: when the first
parameter is `1` and the final byte is a cursor-key letter, the lookup uses
`(final, 0)` (plain cursor key) and the modifier is decoded from the second
parameter via `parseCsiMods`.

==== Source locations

* `src/player/tui/term/screen.nim` — `enableKittyKeys()` / `disableKittyKeys()`
* `src/player/tui/term/term.nim` — re-exports both procs
* `src/player/tui/app.nim` — sends enable after `altScreen()`, disable before exit
* `src/player/tui/input.nim` — `parseCSIu` (CSI-u sequences) and `parseCSI`
  (enhanced cursor-key sequences)

=== Expert Mode
Typing `:` enters command mode in the status bar. The input appears in the
bottom status bar line, with a helix-style completion palette floating above.

Example commands:
----
:move alpha B7
:patrol delta
:roe sigma 8
:build bigun cruiser 3
:tax 45
:research erp 50
:buy ebp 3
----

== Render Loop Architecture

The TUI uses a **frame-based render loop** that decouples rendering from input
processing. This design follows game loop patterns from professional UI
frameworks and ensures consistent input responsiveness.

=== Core Principles

1. **Input is never blocked** - Input is read with 0ms timeout (non-blocking)
2. **All input processed before rendering** - Batched input handling prevents render storms
3. **Fixed frame rate rendering** - 60fps target (~16.67ms per frame)
4. **State changes set a flag** - Model mutations set `needsRender = true`, not trigger immediate render

=== Main Loop Structure

The main loop executes these phases in order each iteration:

----
┌─────────────────────────────────────────────────────────────────────────────┐
│ Phase 1: Drain async proposal queue                                         │
│          Process any proposals queued from async operations                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ Phase 2: Check for terminal resize                                          │
│          Detect SIGWINCH and update terminal dimensions                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Phase 3: Process async operations (Nostr)                                   │
│          Non-blocking check of connection state, publish progress           │
├─────────────────────────────────────────────────────────────────────────────┤
│ Phase 4: Read and process all available input                               │
│          Batch read with 0ms timeout, process each key event through SAM    │
├─────────────────────────────────────────────────────────────────────────────┤
│ Phase 5: Handle game loading and state changes                              │
│          Load game data when transitioning to game view                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Phase 6: Game list maintenance                                              │
│          Update lobby game lists from Nostr events                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ Phase 7: Frame-based rendering (60fps)                                      │
│          Render only if needsRender=true AND frame time elapsed             │
├─────────────────────────────────────────────────────────────────────────────┤
│ Phase 8: Frame pacing                                                       │
│          Sleep until next frame or input available (whichever first)        │
└─────────────────────────────────────────────────────────────────────────────┘
----

=== SAM Integration

The SAM pattern is preserved but render control is moved to the application:

* **SAM handles**: State transitions via `present()`, acceptors, reactors, NAPs
* **Application handles**: Render timing, input batching, frame pacing
* **Rendering**: Explicit `doRender()` call, not triggered by SAM callbacks

This is more aligned with SAM principles because rendering is a side effect
that should be controlled by the application, not triggered automatically by
state changes.

=== Non-Blocking Nostr

The Nostr connection and publish operations use a state machine pattern:

----
Connection States:
  Disconnected → Connecting → Connected → Subscribed
                     ↓
              (timeout: 3s → Disconnected)

Publish States:
  Idle → Publishing → Complete/Failed
              ↓
        (timeout: 3s → Failed)
----

Each main loop iteration checks progress without blocking:

* Connection attempts are started and checked for completion
* Publish operations use async futures checked each frame
* Timeouts prevent infinite waits on failed operations

=== Frame Pacing

After rendering, the loop calculates sleep time:

----
sleepTime = max(1, TargetFrameTimeMs - elapsedMs)
----

The sleep uses `readByteTimeout(sleepTime)` which:

* Returns immediately if input is available (preserving responsiveness)
* Sleeps up to `sleepTime` ms if no input (saving CPU)
* Never blocks longer than one frame (~16ms)

== Entry Modal

=== Layout (72 columns max)
----
┌────────────────────────────────────────────────────────────────────────┐
│                              E C 4 X                                   │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ███████╗ ██████╗██╗  ██╗██╗  ██╗                                      │
│  ██╔════╝██╔════╝██║  ██║╚██╗██╔╝                                      │
│  █████╗  ██║     ███████║ ╚███╔╝                                       │
│  ██╔══╝  ██║     ╚════██║ ██╔██╗                                       │
│  ███████╗╚██████╗     ██║██╔╝ ██╗                                      │
│  ╚══════╝ ╚═════╝     ╚═╝╚═╝  ╚═╝                                      │
│                                                                        │
│  IDENTITY ─────────────────────────────────────────────────────────    │
│  npub1q3z...7xkf (local)                          [I] Import nsec      │
│                                                                        │
│  YOUR GAMES ───────────────────────────────────────────────────────    │
│► Alpha Campaign    T42   House Valerian                                │
│  Beta Skirmish     T18   House Stratos                                 │
│                                                                        │
│  OPEN LOBBIES ─────────────────────────────────────────────────────    │
│  New Galaxy        (3/6 players)                                       │
│                                                                        │
├────────────────────────────────────────────────────────────────────────┤
│  [↑↓]Select [Enter]Play [I]Import [Q]Quit                   v0.1.0      │
└────────────────────────────────────────────────────────────────────────┘
----

== Status Bar

=== Normal Mode
----
Ctrl+ [O] OVR  [Y] CLN  [F] FLT  [T] TECH  ... [:] EXPERT
----

=== Expert Mode
----
:move alpha B7_
----
