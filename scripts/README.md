# EC4X Scripts

Utility scripts for project automation and documentation maintenance.

---

## Game Configuration Scripts

### sync_specs.py

**Purpose:** Generate specification tables from TOML configuration files

**Usage:**
```bash
python3.11 scripts/sync_specs.py
```

**What it does:**
- Reads `config/prestige.toml` and `config/espionage.toml`
- Generates markdown tables with enum names and values
- Updates `docs/specs/reference.md` between HTML comment markers
- Ensures single source of truth for game balance values

**Tables Generated:**
- Prestige sources (18 entries) - ✅ Active
- Penalty mechanics (4 penalty types) - ✅ Active
- Morale levels (7 levels) - ⏳ Pending markers in reference.md
- Espionage actions (7 actions) - ⏳ Pending markers in reference.md

**Example Output:**
```markdown
| Prestige Source | Enum Name | Value |
|-----------------|-----------|-------|
| Tech Advancement | `TechAdvancement` | +2 |
| Colony Establishment | `ColonyEstablishment` | +5 |
```

**Run:** After modifying any TOML config file in `config/`

---

## Development Quality Scripts

### setup_hooks.sh

**Purpose:** Install git pre-commit hooks to enforce code quality

**Usage:**
```bash
bash scripts/setup_hooks.sh
```

**What it does:**
- Installs `.git/hooks/pre-commit` hook
- Automatically runs before each commit
- Prevents non-compliant code from being committed

**Checks Performed:**
1. All enums are `{.pure.}` (NEP-1 requirement)
2. All constants use camelCase (not UPPER_SNAKE_CASE)
3. Project builds successfully (`nimble build`)
4. Critical integration tests pass (3 key tests)

**Bypass:** Use `git commit --no-verify` (not recommended)

**Status:** ✅ Installed and active

---

## Documentation Quality Scripts

### check_formatting.py

**Purpose:** Analyze formatting consistency across specification files

**Usage:**
```bash
python3.11 scripts/check_formatting.py
```

**What it checks:**
- Heading patterns and levels
- Table formatting consistency
- Code block styles
- List formatting
- Bold/italic patterns
- Spacing consistency

**Use case:** Ensuring all spec files follow consistent markdown formatting

---

### check_links.py

**Purpose:** Validate internal links in markdown documentation

**Usage:**
```bash
python3.11 scripts/check_links.py
```

**What it checks:**
- Markdown link syntax `[text](url)`
- Internal file references
- Anchor links to headings
- Broken links detection

**Use case:** Preventing broken links in documentation after reorganization

---

## Data Analysis Scripts

### update_diagnostic_columns.py

**Purpose:** Auto-generate `diagnostic_columns.json` from CSV writer source code

**Usage:**
```bash
python3.11 scripts/update_diagnostic_columns.py
```

**What it does:**
- Parses `src/ai/analysis/diagnostics/csv_writer.nim`
- Extracts the `CSVHeaderString` constant
- Generates JSON with column names, ship classifications, and metadata
- Updates `scripts/analysis/diagnostic_columns.json` in place

**Run:** After adding or modifying diagnostic columns in `csv_writer.nim`

---

### diagnostic_columns.json

**Purpose:** Reference file listing all 200 diagnostic CSV columns

**Location:** `scripts/analysis/diagnostic_columns.json`

**Generated by:** `scripts/update_diagnostic_columns.py`

**Usage:**
```bash
# View all columns
cat scripts/analysis/diagnostic_columns.json | jq '.diagnostic_columns'

# Check what columns exist
cat scripts/analysis/diagnostic_columns.json | jq '.diagnostic_columns[]' | grep treasury

# View ship classifications
cat scripts/analysis/diagnostic_columns.json | jq '.ship_role_classifications'
```

**Contents:**
- `diagnostic_columns` - Complete list of 200 current columns in CSV output
- `ship_role_classifications` - Ships grouped by role (Escort/Capital/Auxiliary/Fighter/SpecialWeapon)
- `ship_classes` - Abbreviation to full name mapping (e.g., "CT" → "Corvette (Escort)")
- Metadata: column_count, last_updated, source file pattern

**Use case:** Quick reference when writing Python analysis scripts without running bash commands

**Maintenance:** Automatically regenerated by `update_diagnostic_columns.py` - don't edit manually

---

### analyze_treasurer_domestikos_flow.py

**Purpose:** Verify Treasurer→Domestikos budget flow (DRY fix verification)

**Location:** `scripts/analysis/analyze_treasurer_domestikos_flow.py`

**Usage:**
```bash
# Analyze specific game seed
python3.11 scripts/analysis/analyze_treasurer_domestikos_flow.py --seed 12345
python3.11 scripts/analysis/analyze_treasurer_domestikos_flow.py -s 12345
```

**What it analyzes:**
- Treasury management per turn (deficits indicate budget problems)
- Ship production rates by role (Escort/Capital/Auxiliary/Fighter/SpecialWeapon)
- Maintenance costs vs available treasury
- Budget discipline summary statistics
- Final fleet composition with ship classifications

**Budget Flow Verification:**
The script uses these diagnostic columns to verify the DRY fix:
- `domestikos_budget_allocated` - PP allocated by Treasurer
- `build_orders_generated` - Build orders created by Domestikos
- `pp_spent_construction` - Actual PP spent
- `domestikos_requirements_fulfilled` - Requirements the Treasurer approved
- `domestikos_requirements_unfulfilled` - Requirements not affordable
- `domestikos_requirements_deferred` - Low-priority requirements deferred

**Verifies:**
- Domestikos never overspends Treasurer's allocation
- Build orders match Treasurer's mediation decisions
- No duplicate budget calculations

**Run:** After RBA budget flow changes to verify correct Treasurer→Domestikos communication

---

## Script Organization

```
scripts/
├── sync_specs.py                  # TOML → spec table generation
├── update_diagnostic_columns.py   # CSV column reference generator
├── setup_hooks.sh                 # Git hook installation
├── check_formatting.py            # Doc formatting validation
├── check_links.py                 # Link validation
├── run_balance_test_parallel.py   # Batch simulation runner
├── analysis/                      # Data analysis scripts (Python + polars)
│   ├── diagnostic_columns.json    # CSV column reference (200 columns, auto-generated)
│   ├── analyze_treasurer_domestikos_flow.py  # Budget flow verification
│   ├── analyze_single_game.py     # Single game detailed analysis
│   ├── analyze_diagnostics.py     # Multi-game aggregate analysis
│   └── [20+ other analysis scripts]
└── README.md                      # This file
```

---

## When to Run

### Always Run
- **sync_specs.py** - After any TOML config change
- **update_diagnostic_columns.py** - After modifying diagnostic columns in csv_writer.nim
- **Pre-commit hook** - Runs automatically before commits

### After Code Changes
- **analyze_treasurer_domestikos_flow.py** - After RBA budget flow changes
- **run_balance_test_parallel.py + analysis scripts** - After AI/balance changes

### Periodic Checks
- **check_formatting.py** - Before major doc updates
- **check_links.py** - After reorganizing docs

### Reference
- **diagnostic_columns.json** - When writing new analysis scripts (regenerate with update_diagnostic_columns.py after CSV changes)

---

## Adding New Scripts

When adding scripts to this directory:

1. Make script executable: `chmod +x scripts/your_script.sh`
2. Add shebang: `#!/usr/bin/env bash` or `#!/usr/bin/env python3.11`
3. Document in this README
4. Follow naming convention: `lowercase_with_underscores`

---

**Last Updated:** 2025-12-13
